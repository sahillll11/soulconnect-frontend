<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoulConnect - Anonymous Friendship Builder</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="SoulConnect">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SoulConnect">
    <meta name="theme-color" content="#2563eb">
    
    <style>
        :root {
            --button-padding: 16px;
            --font-size-base: 16px;
            --card-padding: 24px;
            --gap-size: 15px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #dbeafe 0%, #fae8ff 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            animation: gradientShift 10s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background: linear-gradient(135deg, #dbeafe 0%, #fae8ff 100%); }
            50% { background: linear-gradient(135deg, #f0f9ff 0%, #f3e8ff 100%); }
        }

        /* Device-specific layouts */
        .app-container {
            padding: 10px;
            max-width: 100vw;
            margin: 0 auto;
        }

        /* Mobile Portrait (320px - 480px) */
        @media screen and (max-width: 480px) {
            .app-container {
                padding: 8px;
            }

            .container {
                max-width: 100%;
                padding: 0;
            }

            .header .title {
                font-size: 2rem;
            }

            .features {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .feature {
                padding: 12px;
            }

            .card {
                padding: 16px;
                margin-bottom: 16px;
            }

            .button {
                padding: 14px;
                font-size: 1rem;
            }

            .theme-toggle {
                width: 45px;
                height: 45px;
                top: 15px;
                right: 15px;
            }

            #chatMessages {
                height: 250px !important;
            }
        }

        /* Mobile Landscape (481px - 768px) */
        @media screen and (min-width: 481px) and (max-width: 768px) {
            .app-container {
                padding: 15px;
            }

            .container {
                max-width: 600px;
            }

            .features {
                grid-template-columns: repeat(4, 1fr);
                gap: 12px;
            }

            .dashboard-layout {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }

            #chatMessages {
                height: 350px !important;
            }
        }

        /* Tablet (769px - 1024px) */
        @media screen and (min-width: 769px) and (max-width: 1024px) {
            .app-container {
                padding: 20px;
            }

            .container {
                max-width: 700px;
            }

            .features {
                grid-template-columns: repeat(4, 1fr);
                gap: 15px;
            }

            .dashboard-layout {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }

            .chat-layout {
                display: grid;
                grid-template-columns: 1fr 300px;
                gap: 20px;
            }

            #chatMessages {
                height: 400px !important;
            }
        }

        /* Desktop (1025px+) */
        @media screen and (min-width: 1025px) {
            .app-container {
                padding: 30px;
            }

            .container {
                max-width: 900px;
            }

            .features {
                grid-template-columns: repeat(4, 1fr);
                gap: 20px;
            }

            .dashboard-layout {
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 30px;
            }

            .chat-layout {
                display: grid;
                grid-template-columns: 1fr 350px;
                gap: 25px;
            }

            #chatMessages {
                height: 500px !important;
            }

            .feature-showcase {
                position: fixed;
                right: 20px;
                top: 50%;
                transform: translateY(-50%);
                background: white;
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 10px 25px rgba(0,0,0,0.1);
                max-width: 250px;
                z-index: 100;
                display: none;
            }

            .feature-showcase.show {
                display: block;
            }
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .title {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #2563eb 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #6b7280;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        .description {
            color: #9ca3af;
            font-size: 0.9rem;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .features {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .feature {
            background: white;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }
        
        .feature:hover {
            transform: translateY(-2px);
        }
        
        .feature-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }
        
        .feature-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }
        
        .feature-desc {
            color: #6b7280;
            font-size: 0.8rem;
        }
        
        .button {
            width: 100%;
            padding: 16px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
        }
        
        .button:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }
        
        .button.green {
            background: #16a34a;
        }
        
        .button.green:hover {
            background: #15803d;
        }
        
        .button.purple {
            background: #9333ea;
        }
        
        .button.purple:hover {
            background: #7c3aed;
        }
        
        .success {
            background: #f0f9ff;
            border: 1px solid #bfdbfe;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }
        
        .success-title {
            color: #1e40af;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .success-text {
            color: #1e40af;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .install-prompt {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #2563eb;
            color: white;
            padding: 12px;
            text-align: center;
            z-index: 1000;
            display: none;
        }
        
        .install-prompt.show {
            display: block;
        }
        
        .install-btn {
            background: white;
            color: #2563eb;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            margin-left: 12px;
            cursor: pointer;
        }
        
        .status-badge {
            background: #dcfce7;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 20px;
        }

        /* Dark Mode Styles */
        .dark-mode {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: #f1f5f9;
        }

        .dark-mode .card {
            background: #334155;
            color: #f1f5f9;
        }

        .dark-mode .feature {
            background: #475569;
            color: #f1f5f9;
        }

        .dark-mode input, .dark-mode select {
            background: #475569;
            color: #f1f5f9;
            border-color: #64748b;
        }

        /* Voice Message Styles */
        .voice-btn {
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .voice-btn:hover {
            background: #b91c1c;
            transform: scale(1.1);
        }

        .voice-btn.recording {
            background: #ef4444;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Emoji Reaction Styles */
        .emoji-reactions {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            flex-wrap: wrap;
        }

        .emoji-btn {
            background: rgba(37, 99, 235, 0.1);
            border: 1px solid rgba(37, 99, 235, 0.3);
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .emoji-btn:hover {
            background: rgba(37, 99, 235, 0.2);
            transform: scale(1.1);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            background: #f3f4f6;
            border-radius: 12px;
            margin-bottom: 8px;
            font-style: italic;
            color: #6b7280;
        }

        .typing-dots {
            display: flex;
            gap: 2px;
        }

        .typing-dot {
            width: 4px;
            height: 4px;
            background: #6b7280;
            border-radius: 50%;
            animation: typingDot 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingDot {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: #1d4ed8;
            transform: scale(1.1);
        }

        /* Professional AI Chat Styling */
        .quick-btn {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-btn:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
        }

        /* Pulse animation for typing indicator */
        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        /* Enhanced button styles */
        .button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* AI personality selector styling */
        #aiPersonalitySelect {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        #aiPersonalitySelect:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Wellness Cards */
        .wellness-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .wellness-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-color: #3b82f6;
        }

        .wellness-card h3 {
            margin: 8px 0 4px 0;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .wellness-card p {
            margin: 0;
            color: #6b7280;
            font-size: 0.9rem;
        }

        /* Enhanced Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        /* Professional animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            animation: fadeIn 0.3s ease-out;
        }

        /* Mobile responsive improvements */
        @media (max-width: 480px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .wellness-card {
                padding: 16px;
            }
        }

        /* Coping Strategy Cards */
        .coping-card {
            background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);
            border: 2px solid #d1fae5;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .coping-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-color: #10b981;
        }

        .coping-card h3 {
            margin: 0 0 8px 0;
            color: #065f46;
            font-size: 1.1rem;
        }

        .coping-card p {
            margin: 0;
            color: #6b7280;
            font-size: 0.9rem;
        }

        /* Mood Option Cards */
        .mood-option {
            background: linear-gradient(135deg, #ffffff 0%, #fef7ff 100%);
            border: 2px solid #e9d5ff;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mood-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-color: #8b5cf6;
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        }

        /* Enhanced animations */
        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .breathing-animation {
            animation: breathe 4s infinite ease-in-out;
        }

        /* Journal and mood cards */
        .feature-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        /* Progress indicators */
        .progress-bar {
            background: #e5e7eb;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            height: 100%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()">üåô</button>

    <!-- Install Prompt Hidden -->
    <div id="installPrompt" class="install-prompt" style="display: none;">
        <div class="install-content">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <div style="font-size: 2rem;">üì±</div>
                <div>
                    <div style="font-weight: 600; color: white;">Install SoulConnect</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">Get the full app experience</div>
                </div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button id="installBtn" class="install-btn">Install Now</button>
                <button id="moreInfoBtn" onclick="showInstallInfo()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer;">Learn More</button>
                <button id="dismissBtn" style="background: none; border: none; color: white; padding: 8px; cursor: pointer; opacity: 0.8;">‚úï</button>
            </div>
        </div>
    </div>

    <!-- Install Info Modal -->
    <div id="installInfoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; padding: 20px; box-sizing: border-box;">
        <div style="background: white; border-radius: 16px; max-width: 500px; margin: 50px auto; padding: 0; max-height: 80vh; overflow: hidden;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); padding: 24px; color: white; text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 8px;">üì±</div>
                <h3 style="margin: 0; font-size: 1.5rem;">Install SoulConnect</h3>
                <p style="margin: 8px 0 0 0; opacity: 0.9;">Your personal mental health companion</p>
            </div>

            <!-- Content -->
            <div style="padding: 24px;">
                <div style="display: grid; gap: 16px; margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="background: #dbeafe; color: #1d4ed8; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">üöÄ</div>
                        <div>
                            <div style="font-weight: 600; color: #1f2937;">Instant Access</div>
                            <div style="font-size: 0.9rem; color: #6b7280;">Launch from your home screen like any app</div>
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="background: #dcfce7; color: #16a34a; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">üì∂</div>
                        <div>
                            <div style="font-weight: 600; color: #1f2937;">Works Offline</div>
                            <div style="font-size: 0.9rem; color: #6b7280;">Access your tools even without internet</div>
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="background: #fef3c7; color: #d97706; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">üîî</div>
                        <div>
                            <div style="font-weight: 600; color: #1f2937;">Smart Notifications</div>
                            <div style="font-size: 0.9rem; color: #6b7280;">Gentle reminders for self-care</div>
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="background: #fce7f3; color: #be185d; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">üîí</div>
                        <div>
                            <div style="font-weight: 600; color: #1f2937;">Private & Secure</div>
                            <div style="font-size: 0.9rem; color: #6b7280;">Your data stays on your device</div>
                        </div>
                    </div>
                </div>

                <div style="display: grid; gap: 12px;">
                    <button id="installNowBtn" onclick="triggerInstall()" class="button" style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); width: 100%;">
                        üì± Install SoulConnect Now
                    </button>
                    <button onclick="showManualInstall()" class="button" style="background: #f3f4f6; color: #374151; width: 100%;">
                        üìã Manual Install Instructions
                    </button>
                    <button onclick="closeInstallInfo()" style="background: none; border: none; color: #6b7280; padding: 12px; cursor: pointer; width: 100%;">
                        Maybe Later
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <div class="container">
            <!-- Device Info Badge (Hidden) -->
            <div id="deviceInfo" style="display: none;"></div>

            <!-- Feature Tour Button (Hidden - accessible via settings) -->
            <div style="display: none;">
                <button onclick="startFeatureTour()" style="background: #8b5cf6; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer;">
                    üéØ Take Feature Tour
                </button>
            </div>

            <!-- Header -->
            <div class="header">
                <h1 class="title">SoulConnect</h1>
                <p class="subtitle">Anonymous Friendship Builder</p>
                <p class="description">Talk to someone who understands you</p>
                <div class="status-badge">üéâ Fully Working!</div>
            </div>

        </div>

        <!-- Auth Section -->
        <div class="card" id="authSection">
            <h2 style="text-align: center; margin-bottom: 20px; color: #1f2937;" id="authTitle">Create Account</h2>

            <div id="errorMessage" style="background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 12px; border-radius: 8px; margin-bottom: 16px; display: none;"></div>

            <form id="authForm">
                <input type="text" id="username" placeholder="Username" style="width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px;" required>

                <input type="email" id="email" placeholder="Email" style="width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px;" required>

                <input type="password" id="password" placeholder="Password" style="width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px;" required>

                <select id="avatar" style="width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px;">
                    <option value="fox">ü¶ä Fox</option>
                    <option value="cat">üê± Cat</option>
                    <option value="dog">üê∂ Dog</option>
                    <option value="bear">üêª Bear</option>
                    <option value="rabbit">üê∞ Rabbit</option>
                </select>

                <select id="mood" style="width: 100%; padding: 12px; margin-bottom: 16px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px;">
                    <option value="happy">üòä Happy</option>
                    <option value="sad">üò¢ Sad</option>
                    <option value="anxious">üò∞ Anxious</option>
                    <option value="lonely">üòî Lonely</option>
                    <option value="excited">ü§ó Excited</option>
                </select>

                <button type="submit" id="submitBtn" class="button">
                    üìù Create Account
                </button>
            </form>

            <div style="text-align: center; margin-top: 16px;">
                <button onclick="toggleAuthMode()" id="switchBtn" style="background: none; border: none; color: #2563eb; font-weight: 500; cursor: pointer;">
                    Already have an account? Sign in
                </button>
            </div>
        </div>

        <!-- Dashboard Section (Hidden initially) -->
        <div class="card" id="dashboardSection" style="display: none;">
            <h2 style="text-align: center; margin-bottom: 20px; color: #1f2937;">Welcome to SoulConnect!</h2>

            <div id="userInfo" style="text-align: center; margin-bottom: 20px; padding: 16px; background: #f3f4f6; border-radius: 8px;"></div>

            <div id="statsInfo" style="text-align: center; margin-bottom: 20px; padding: 16px; background: #ecfdf5; border: 1px solid #bbf7d0; border-radius: 8px;"></div>

            <!-- Mood Update -->
            <div style="margin-bottom: 16px;">
                <h4 style="margin-bottom: 8px; color: #1f2937;">How are you feeling?</h4>
                <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="updateMood('happy', 'üòä')" class="emoji-btn">üòä Happy</button>
                    <button onclick="updateMood('sad', 'üò¢')" class="emoji-btn">üò¢ Sad</button>
                    <button onclick="updateMood('anxious', 'üò∞')" class="emoji-btn">üò∞ Anxious</button>
                    <button onclick="updateMood('lonely', 'üòî')" class="emoji-btn">üòî Lonely</button>
                    <button onclick="updateMood('excited', 'ü§ó')" class="emoji-btn">ü§ó Excited</button>
                </div>
            </div>

            <!-- Main Actions -->
            <div class="dashboard-grid">
                <button onclick="startChat()" class="button purple" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                    üéØ Find Friend
                </button>
                <button onclick="startAIChat()" class="button" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                    ü§ñ AI Companion
                </button>
            </div>

            <!-- Wellness & Self-Care -->
            <div class="dashboard-grid">
                <button onclick="showWellnessCenter()" class="button" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    üå± Wellness Center
                </button>
                <button onclick="showJournal()" class="button" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                    üìù Personal Journal
                </button>
            </div>

            <!-- Insights & Profile -->
            <div class="dashboard-grid">
                <button onclick="showMoodTracker()" class="button" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">
                    üìä Mood Insights
                </button>
                <button onclick="showProfile()" class="button green" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    üë§ My Profile
                </button>
            </div>

            <!-- Quick Actions -->
            <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                <button onclick="showEmergencySupport()" class="button" style="flex: 1; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); font-size: 0.9rem;">
                    üÜò Crisis Support
                </button>
                <button onclick="showSettings()" class="button" style="flex: 1; background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); font-size: 0.9rem;">
                    ‚öôÔ∏è Settings
                </button>
            </div>

            <button onclick="logout()" class="button" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); width: 100%;">
                üö™ Logout
            </button>
        </div>

        <!-- AI Chat Section -->
        <div class="card" id="aiChatSection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #1f2937; margin: 0;">ü§ñ AI Companion</h2>
                <button onclick="closeChatSection()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úï</button>
            </div>

            <!-- AI Personality Selector -->
            <div style="margin-bottom: 16px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Choose AI Personality:</label>
                <select id="aiPersonalitySelect" onchange="changeAIPersonality()" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                    <option value="supportive">üíô Supportive Friend - Understanding & caring</option>
                    <option value="professional">üéØ Professional Counselor - Structured guidance</option>
                    <option value="empathetic">ü§ó Empathetic Listener - Deep emotional support</option>
                    <option value="motivational">‚ö° Motivational Coach - Encouraging & uplifting</option>
                </select>
            </div>

            <div id="aiChatMessages" style="height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 16px; background: #fafafa;"></div>

            <!-- AI Chat Input -->
            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                <input type="text" id="aiMessageInput" placeholder="Share your feelings..." style="flex: 1; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px;" onkeypress="handleAIKeyPress(event)">
                <button onclick="sendAIMessage()" style="background: #3b82f6; color: white; border: none; padding: 12px 16px; border-radius: 8px; cursor: pointer;">
                    üì§
                </button>
            </div>

            <!-- AI Quick Responses -->
            <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 16px;">
                <button onclick="sendQuickAIMessage('I feel anxious today')" class="quick-btn">üò∞ Feeling anxious</button>
                <button onclick="sendQuickAIMessage('I feel lonely')" class="quick-btn">üòî Feeling lonely</button>
                <button onclick="sendQuickAIMessage('I need motivation')" class="quick-btn">‚ö° Need motivation</button>
                <button onclick="sendQuickAIMessage('I had a bad day')" class="quick-btn">üòû Bad day</button>
            </div>
        </div>

        <!-- Anonymous Chat Section -->
        <div class="card" id="chatSection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #1f2937; margin: 0;">üéØ Anonymous Chat</h2>
                <button onclick="closeChatSection()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úï</button>
            </div>

            <div id="chatPartner" style="text-align: center; margin-bottom: 16px; padding: 12px; background: #f3f4f6; border-radius: 8px;"></div>

            <div id="chatMessages" style="height: 300px; overflow-y: auto; border: 1px solid #d1d5db; border-radius: 8px; padding: 12px; margin-bottom: 12px; background: #fafafa;"></div>

            <div id="typingIndicator" class="typing-indicator" style="display: none;">
                <span>Partner is typing</span>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>

            <!-- Emoji Quick Reactions -->
            <div style="display: flex; gap: 4px; margin-bottom: 8px; justify-content: center;">
                <button onclick="sendQuickEmoji('‚ù§Ô∏è')" class="emoji-btn">‚ù§Ô∏è</button>
                <button onclick="sendQuickEmoji('üòä')" class="emoji-btn">üòä</button>
                <button onclick="sendQuickEmoji('üò¢')" class="emoji-btn">üò¢</button>
                <button onclick="sendQuickEmoji('üëç')" class="emoji-btn">üëç</button>
                <button onclick="sendQuickEmoji('ü§ó')" class="emoji-btn">ü§ó</button>
                <button onclick="sendQuickEmoji('üòÇ')" class="emoji-btn">üòÇ</button>
            </div>

            <div style="display: flex; gap: 8px; align-items: center;">
                <input type="text" id="messageInput" placeholder="Type your message..." style="flex: 1; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px;" onkeypress="handleTyping(event)">
                <button id="voiceBtn" onclick="toggleVoiceRecording()" class="voice-btn" title="Voice Message">üé§</button>
                <button onclick="sendMessage()" class="button" style="width: auto; padding: 12px 20px;">Send</button>
            </div>

            <div id="voiceRecording" style="display: none; text-align: center; margin-top: 8px; padding: 8px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px;">
                <span>üî¥ Recording... Tap microphone to stop</span>
            </div>

            <button onclick="endChat()" class="button" style="background: #dc2626; margin-top: 12px;">
                ‚ùå End Chat
            </button>
        </div>

        <!-- Welcome Message -->
        <div class="success">
            <div class="success-title">üíô Welcome to SoulConnect</div>
            <div class="success-text">
                <strong>Anonymous Friendship Builder</strong><br><br>
                Connect with someone who understands you without judgment.<br><br>

                <strong>Features:</strong><br>
                ‚Ä¢ üí¨ Anonymous conversations<br>
                ‚Ä¢ üé§ Voice messages<br>
                ‚Ä¢ üòä Emoji reactions<br>
                ‚Ä¢ üìä Mood tracking<br>
                ‚Ä¢ üåô Dark mode<br>
                ‚Ä¢ üì± Mobile app experience<br><br>

                <strong>Safe ‚Ä¢ Anonymous ‚Ä¢ Understanding</strong>
            </div>
        </div>

        <!-- Desktop Feature Showcase (Hidden) -->
        <div id="featureShowcase" class="feature-showcase" style="display: none;">
            <h4 style="margin-bottom: 12px; color: #1f2937;">üöÄ Features</h4>
            <div style="font-size: 0.8rem; line-height: 1.4;">
                <div style="margin-bottom: 8px;">üé§ Voice Messages</div>
                <div style="margin-bottom: 8px;">üòä Emoji Reactions</div>
                <div style="margin-bottom: 8px;">üåô Dark Mode</div>
                <div style="margin-bottom: 8px;">‚å®Ô∏è Typing Indicators</div>
                <div style="margin-bottom: 8px;">üîî Push Notifications</div>
                <div style="margin-bottom: 8px;">üìä Mood Tracking</div>
                <div style="margin-bottom: 8px;">üë§ Profile Management</div>
                <div style="margin-bottom: 8px;">üõ°Ô∏è Anonymous & Safe</div>
            </div>
        </div>
    </div>

    <script>
        // PWA Installation
        let deferredPrompt;
        const installPrompt = document.getElementById('installPrompt');
        const installBtn = document.getElementById('installBtn');
        const dismissBtn = document.getElementById('dismissBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Install prompt hidden - let browser handle natively
            // installPrompt.classList.add('show');
        });

        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                installPrompt.classList.remove('show');
                showSuccess('üéâ App installed! Check your home screen.');
            }
            deferredPrompt = null;
        });

        dismissBtn.addEventListener('click', () => {
            installPrompt.classList.remove('show');
        });

        // Global variables
        let currentUser = null;
        let authToken = null;
        let currentChatRoom = null;
        let isLoginMode = false;
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let typingTimer = null;
        let aiChatMode = false;
        let aiPersonality = 'supportive';
        let aiConversationHistory = [];
        let lastActiveTime = Date.now();
        let inactivityTimer = null;
        let isDarkMode = false;
        let deviceType = 'unknown';
        let screenSize = 'unknown';

        // Auth Functions
        async function handleAuth(event) {
            event.preventDefault();

            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const avatar = document.getElementById('avatar').value;
            const mood = document.getElementById('mood').value;

            if (!username || !password) {
                showError('Please fill in all required fields');
                return;
            }

            if (!isLoginMode && (!email || !avatar || !mood)) {
                showError('Please fill in all fields for registration');
                return;
            }

            if (password.length < 6) {
                showError('Password must be at least 6 characters long');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.textContent = 'Please wait...';
            submitBtn.disabled = true;

            try {
                const endpoint = isLoginMode ? '/api/auth/login' : '/api/auth/register';
                const body = isLoginMode
                    ? { username, password }
                    : { username, email, password, avatar, mood };

                const response = await fetch(`https://soulconnect-backend-4.onrender.com${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body),
                });

                const data = await response.json();

                if (data.success) {
                    currentUser = data.user;
                    authToken = data.token;

                    // Store user data persistently
                    localStorage.setItem('soulconnect_token', authToken);
                    localStorage.setItem('soulconnect_user', JSON.stringify(currentUser));
                    localStorage.setItem('soulconnect_logged_in', 'true');
                    localStorage.setItem('soulconnect_last_login', new Date().toISOString());

                    console.log('‚úÖ Authentication successful:', currentUser.username);

                    // Hide auth section and show dashboard
                    document.getElementById('authSection').style.display = 'none';
                    showDashboard();
                    loadStats();

                    // Show appropriate welcome message
                    const welcomeMsg = isLoginMode ?
                        `Welcome back, ${currentUser.username}! üéâ\n\nGlad to see you again.` :
                        `Welcome to SoulConnect, ${currentUser.username}! üéâ\n\nYour account has been created successfully!`;

                    showSuccess(welcomeMsg);
                } else {
                    showError(data.error || 'Authentication failed. Please try again.');
                }
            } catch (error) {
                showError('Network error. Check your internet connection.');
            } finally {
                submitBtn.textContent = isLoginMode ? 'üîë Sign In' : 'üìù Create Account';
                submitBtn.disabled = false;
            }
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            const authTitle = document.getElementById('authTitle');
            const emailField = document.getElementById('email');
            const avatarField = document.getElementById('avatar');
            const moodField = document.getElementById('mood');
            const submitBtn = document.getElementById('submitBtn');
            const switchBtn = document.getElementById('switchBtn');

            if (isLoginMode) {
                authTitle.textContent = 'Welcome Back!';
                emailField.style.display = 'none';
                avatarField.style.display = 'none';
                moodField.style.display = 'none';
                submitBtn.textContent = 'üîë Sign In';
                switchBtn.textContent = "Don't have an account? Sign up";
            } else {
                authTitle.textContent = 'Create Account';
                emailField.style.display = 'block';
                avatarField.style.display = 'block';
                moodField.style.display = 'block';
                submitBtn.textContent = 'üìù Create Account';
                switchBtn.textContent = 'Already have an account? Sign in';
            }
        }



        async function loadStats() {
            try {
                const response = await fetch('https://soulconnect-backend-4.onrender.com/api/stats');
                const data = await response.json();

                if (data.success) {
                    const statsInfo = document.getElementById('statsInfo');
                    statsInfo.innerHTML = `
                        <h4>üìä Community Stats</h4>
                        <p>üë• ${data.stats.totalUsers} Total Users ‚Ä¢ üü¢ ${data.stats.onlineUsers} Online</p>
                        <p>üí¨ ${data.stats.totalChats} Chats Started ‚Ä¢ üìù ${data.stats.totalMessages} Messages Sent</p>
                    `;
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function startChat() {
            try {
                const response = await fetch('https://soulconnect-backend-4.onrender.com/api/chat/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    currentChatRoom = data.chatRoom;
                    showChatInterface(data.partner);
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('Failed to start chat. Please try again.');
            }
        }



        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message) return;

            try {
                const response = await fetch('https://soulconnect-backend-4.onrender.com/api/chat/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        chatRoomId: currentChatRoom.id,
                        message
                    })
                });

                const data = await response.json();

                if (data.success) {
                    messageInput.value = '';
                    displayMessage(data.message, true);
                } else {
                    showError('Failed to send message');
                }
            } catch (error) {
                showError('Failed to send message. Please try again.');
            }
        }

        async function pollMessages() {
            if (!currentChatRoom) return;

            try {
                const response = await fetch(`https://soulconnect-backend-4.onrender.com/api/chat/messages?chatRoomId=${currentChatRoom.id}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';

                    data.messages.forEach(msg => {
                        displayMessage(msg, msg.userId === currentUser.id);
                    });

                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            } catch (error) {
                console.error('Failed to load messages:', error);
            }

            // Poll again in 2 seconds
            setTimeout(pollMessages, 2000);
        }

        function displayMessage(message, isOwn) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                margin-bottom: 12px;
                padding: 8px 12px;
                border-radius: 12px;
                max-width: 80%;
                ${isOwn
                    ? 'background: #2563eb; color: white; margin-left: auto; text-align: right;'
                    : 'background: #f3f4f6; color: #1f2937; margin-right: auto;'
                }
            `;

            messageDiv.innerHTML = `
                <div style="font-weight: 500; font-size: 0.8rem; margin-bottom: 4px;">
                    ${isOwn ? 'You' : message.username}
                </div>
                <div>${message.message}</div>
                <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 4px;">
                    ${new Date(message.createdAt).toLocaleTimeString()}
                </div>
            `;

            chatMessages.appendChild(messageDiv);
        }

        function endChat() {
            currentChatRoom = null;
            document.getElementById('chatSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
            showSuccess('Chat ended. You can start a new chat anytime!');
        }

        function logout() {
            currentUser = null;
            authToken = null;
            currentChatRoom = null;
            localStorage.removeItem('soulconnect_token');
            localStorage.removeItem('soulconnect_user');

            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('chatSection').style.display = 'none';
            document.getElementById('authSection').style.display = 'block';

            // Reset form
            document.getElementById('authForm').reset();
            showSuccess('Logged out successfully!');
        }

        // Helper functions
        function getAvatarEmoji(avatar) {
            const avatars = {
                fox: 'ü¶ä', cat: 'üê±', dog: 'üê∂', bear: 'üêª', rabbit: 'üê∞'
            };
            return avatars[avatar] || 'ü¶ä';
        }

        function getMoodEmoji(mood) {
            const moods = {
                happy: 'üòä', sad: 'üò¢', anxious: 'üò∞', lonely: 'üòî', excited: 'ü§ó'
            };
            return moods[mood] || 'üòä';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            alert(message);
        }

        // Feature Tour
        function startFeatureTour() {
            const tourSteps = [
                {
                    title: "üåô Dark Mode Toggle",
                    message: "Tap the moon/sun button (top right) to switch between light and dark themes. Your preference is saved automatically!"
                },
                {
                    title: "üìù Smart Registration",
                    message: "Create your account with username, email, and password. Choose your avatar (ü¶äüê±üê∂üêªüê∞) and current mood!"
                },
                {
                    title: "üí¨ Anonymous Matching",
                    message: "Get matched with other online users for anonymous conversations. No personal info shared!"
                },
                {
                    title: "üé§ Voice Messages",
                    message: "In chat, tap the microphone button to record and send voice messages. Perfect for expressing emotions!"
                },
                {
                    title: "üòä Quick Emoji Reactions",
                    message: "Use the emoji buttons (‚ù§Ô∏èüòäüò¢üëçü§óüòÇ) for quick reactions and emotional responses!"
                },
                {
                    title: "üìä Mood Tracking",
                    message: "Update your mood on the dashboard. Track your emotional journey over time!"
                },
                {
                    title: "üîî Push Notifications",
                    message: "Get notified of new messages even when the app is in the background!"
                },
                {
                    title: "üì± PWA Installation",
                    message: "Install SoulConnect as an app on your device for the best experience!"
                },
                {
                    title: "üéØ Device Optimization",
                    message: `Your ${deviceType} layout is optimized for ${screenSize} screens. All features are fully visible and easy to use!`
                }
            ];

            let currentStep = 0;

            function showNextStep() {
                if (currentStep < tourSteps.length) {
                    const step = tourSteps[currentStep];
                    const continueText = currentStep < tourSteps.length - 1 ? "\n\nTap OK to continue..." : "\n\nTour complete! Enjoy SoulConnect! üéâ";

                    alert(`${step.title}\n\n${step.message}${continueText}`);
                    currentStep++;

                    if (currentStep < tourSteps.length) {
                        setTimeout(showNextStep, 500);
                    }
                } else {
                    showSuccess("üéâ Feature tour complete!\n\nYou're now ready to use all of SoulConnect's amazing features!\n\nStart by creating an account or signing in!");
                }
            }

            showNextStep();
        }

        // New Feature Functions

        // Dark Mode Toggle
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            const body = document.body;
            const themeToggle = document.getElementById('themeToggle');

            if (isDarkMode) {
                body.classList.add('dark-mode');
                themeToggle.textContent = '‚òÄÔ∏è';
                localStorage.setItem('soulconnect_theme', 'dark');
            } else {
                body.classList.remove('dark-mode');
                themeToggle.textContent = 'üåô';
                localStorage.setItem('soulconnect_theme', 'light');
            }
        }

        // Voice Recording
        async function toggleVoiceRecording() {
            const voiceBtn = document.getElementById('voiceBtn');
            const voiceRecording = document.getElementById('voiceRecording');

            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        sendVoiceMessage(audioBlob);
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    voiceBtn.classList.add('recording');
                    voiceRecording.style.display = 'block';

                } catch (error) {
                    showError('Microphone access denied. Please allow microphone access to send voice messages.');
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                voiceBtn.classList.remove('recording');
                voiceRecording.style.display = 'none';
            }
        }

        async function sendVoiceMessage(audioBlob) {
            // Convert audio to base64 for demo (in production, upload to server)
            const reader = new FileReader();
            reader.onload = async () => {
                const base64Audio = reader.result.split(',')[1];

                try {
                    const response = await fetch('https://soulconnect-backend-4.onrender.com/api/chat/send', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            chatRoomId: currentChatRoom.id,
                            message: 'üé§ Voice Message',
                            type: 'voice',
                            audioData: base64Audio
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        displayMessage(data.message, true);
                    } else {
                        showError('Failed to send voice message');
                    }
                } catch (error) {
                    showError('Failed to send voice message. Please try again.');
                }
            };
            reader.readAsDataURL(audioBlob);
        }

        // Quick Emoji Reactions
        async function sendQuickEmoji(emoji) {
            try {
                const response = await fetch('https://soulconnect-backend-4.onrender.com/api/chat/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        chatRoomId: currentChatRoom.id,
                        message: emoji,
                        type: 'emoji'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayMessage(data.message, true);
                } else {
                    showError('Failed to send emoji');
                }
            } catch (error) {
                showError('Failed to send emoji. Please try again.');
            }
        }

        // Typing Indicator
        function handleTyping(event) {
            if (event.key === 'Enter') {
                sendMessage();
                return;
            }

            // Show typing indicator to other user (simplified for demo)
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                // Hide typing indicator after 2 seconds of no typing
            }, 2000);
        }

        // Enhanced Message Display
        function displayMessage(message, isOwn) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');

            const isVoice = message.type === 'voice';
            const isEmoji = message.type === 'emoji';

            messageDiv.style.cssText = `
                margin-bottom: 12px;
                padding: 8px 12px;
                border-radius: 12px;
                max-width: 80%;
                ${isOwn
                    ? 'background: #2563eb; color: white; margin-left: auto; text-align: right;'
                    : 'background: #f3f4f6; color: #1f2937; margin-right: auto;'
                }
                ${isEmoji ? 'font-size: 2rem; text-align: center; padding: 4px 8px;' : ''}
            `;

            let messageContent = message.message;

            if (isVoice) {
                messageContent = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span>üé§</span>
                        <button onclick="playVoiceMessage('${message.audioData}')" style="background: none; border: none; color: inherit; cursor: pointer;">
                            ‚ñ∂Ô∏è Voice Message
                        </button>
                    </div>
                `;
            }

            messageDiv.innerHTML = `
                <div style="font-weight: 500; font-size: 0.8rem; margin-bottom: 4px;">
                    ${isOwn ? 'You' : message.username}
                </div>
                <div>${messageContent}</div>
                <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 4px;">
                    ${new Date(message.createdAt).toLocaleTimeString()}
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function playVoiceMessage(audioData) {
            try {
                const audio = new Audio(`data:audio/wav;base64,${audioData}`);
                audio.play();
            } catch (error) {
                showError('Failed to play voice message');
            }
        }

        // Mood Tracking
        async function updateMood(mood, emoji) {
            try {
                currentUser.mood = mood;
                localStorage.setItem('soulconnect_user', JSON.stringify(currentUser));

                // Update UI
                showDashboard();
                showSuccess(`Mood updated to ${emoji} ${mood}!`);

                // Track mood history (simplified)
                const moodHistory = JSON.parse(localStorage.getItem('soulconnect_mood_history') || '[]');
                moodHistory.push({
                    mood,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('soulconnect_mood_history', JSON.stringify(moodHistory));

            } catch (error) {
                showError('Failed to update mood');
            }
        }

        // Profile Management
        function showProfile() {
            const moodHistory = JSON.parse(localStorage.getItem('soulconnect_mood_history') || '[]');
            const recentMoods = moodHistory.slice(-5).reverse();

            let moodHistoryText = 'Recent mood updates:\n';
            recentMoods.forEach(entry => {
                const date = new Date(entry.timestamp).toLocaleDateString();
                moodHistoryText += `‚Ä¢ ${getMoodEmoji(entry.mood)} ${entry.mood} (${date})\n`;
            });

            const profileInfo = `
üë§ Your SoulConnect Profile

Username: ${currentUser.username}
Avatar: ${getAvatarEmoji(currentUser.avatar)} ${currentUser.avatar}
Current Mood: ${getMoodEmoji(currentUser.mood)} ${currentUser.mood}
Joined: ${new Date(currentUser.createdAt).toLocaleDateString()}
Last Seen: ${new Date(currentUser.lastSeen).toLocaleDateString()}

${moodHistoryText}

üí° Tip: Regular mood tracking helps you understand your emotional patterns!
            `;

            alert(profileInfo);
        }

        // Initialize
        document.getElementById('authForm').addEventListener('submit', handleAuth);

        // Push Notifications
        async function requestNotificationPermission() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    showSuccess('üîî Notifications enabled! You\'ll get alerts for new messages.');
                }
            }
        }

        function showNotification(title, body, icon = 'üí¨') {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='70' font-size='60' x='50' text-anchor='middle'>${icon}</text></svg>`,
                    badge: `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%232563eb'/></svg>`
                });
            }
        }

        // Enhanced Message Polling with Notifications
        async function pollMessages() {
            if (!currentChatRoom) return;

            try {
                const response = await fetch(`https://soulconnect-backend-4.onrender.com/api/chat/messages?chatRoomId=${currentChatRoom.id}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const chatMessages = document.getElementById('chatMessages');
                    const currentMessageCount = chatMessages.children.length;

                    chatMessages.innerHTML = '';

                    data.messages.forEach(msg => {
                        displayMessage(msg, msg.userId === currentUser.id);
                    });

                    // Show notification for new messages
                    if (data.messages.length > currentMessageCount && document.hidden) {
                        const lastMessage = data.messages[data.messages.length - 1];
                        if (lastMessage.userId !== currentUser.id) {
                            showNotification(
                                'New message from ' + lastMessage.username,
                                lastMessage.message,
                                lastMessage.type === 'emoji' ? lastMessage.message : 'üí¨'
                            );
                        }
                    }

                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            } catch (error) {
                console.error('Failed to load messages:', error);
            }

            // Poll again in 2 seconds
            setTimeout(pollMessages, 2000);
        }

        // Mobile App Functions
        function initMobileApp() {
            // Check if running as PWA
            if (window.matchMedia('(display-mode: standalone)').matches ||
                window.navigator.standalone === true) {
                isMobileApp = true;
                document.body.classList.add('mobile-app');

                // Show mobile status bar and navigation
                document.getElementById('mobileStatusBar').classList.add('show');
                document.getElementById('mobileNav').classList.add('show');

                // Update status bar
                updateStatusBar();
                setInterval(updateStatusBar, 1000);

                // Add mobile gestures
                addMobileGestures();

                // Hide install prompt
                document.getElementById('installPrompt').style.display = 'none';
            }
        }

        function updateStatusBar() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            document.getElementById('statusTime').textContent = timeString;

            // Simulate battery and signal (in real app, use Battery API)
            const battery = Math.floor(Math.random() * 30) + 70; // 70-100%
            document.getElementById('statusBattery').textContent = battery > 80 ? 'üîã' : battery > 20 ? 'ü™´' : 'üî¥';
        }

        function showSection(section) {
            currentSection = section;

            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');

            // Handle section switching
            switch(section) {
                case 'home':
                    if (currentUser) {
                        document.getElementById('dashboardSection').style.display = 'block';
                        document.getElementById('chatSection').style.display = 'none';
                        document.getElementById('authSection').style.display = 'none';
                    } else {
                        document.getElementById('authSection').style.display = 'block';
                        document.getElementById('dashboardSection').style.display = 'none';
                        document.getElementById('chatSection').style.display = 'none';
                    }
                    break;
                case 'chat':
                    if (currentUser) {
                        startChat();
                    } else {
                        showError('Please login first to start chatting');
                        showSection('home');
                    }
                    break;
                case 'profile':
                    if (currentUser) {
                        showProfile();
                    } else {
                        showError('Please login first to view profile');
                        showSection('home');
                    }
                    break;
                case 'settings':
                    showSettings();
                    break;
            }

            // Add haptic feedback
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
        }

        function showSettings() {
            const settings = `
üîß SoulConnect Settings

üåô Theme: ${isDarkMode ? 'Dark' : 'Light'} Mode
üì± Device: ${deviceType}
üîî Notifications: ${Notification.permission}
üìä App Version: 2.0.0

Options:
‚Ä¢ Tap "Take Tour" for feature guide
‚Ä¢ Toggle theme with moon/sun button
‚Ä¢ Enable notifications for alerts

Tap OK to close settings.
            `;

            if (confirm(settings + '\n\nWould you like to take the feature tour?')) {
                startFeatureTour();
            }
        }

        function addMobileGestures() {
            let startY = 0;
            let currentY = 0;

            // Pull to refresh
            document.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
                pullStartY = startY;
            });

            document.addEventListener('touchmove', (e) => {
                currentY = e.touches[0].clientY;
                const diff = currentY - startY;

                if (diff > 0 && window.scrollY === 0 && !isPulling) {
                    isPulling = true;
                    const pullToRefresh = document.getElementById('pullToRefresh');

                    if (diff > 100) {
                        pullToRefresh.classList.add('show');
                        pullToRefresh.innerHTML = '<span>üîÑ Release to refresh</span>';
                    } else {
                        pullToRefresh.innerHTML = '<span>‚¨áÔ∏è Pull to refresh</span>';
                    }
                }
            });

            document.addEventListener('touchend', (e) => {
                const diff = currentY - pullStartY;

                if (isPulling && diff > 100) {
                    // Trigger refresh
                    const pullToRefresh = document.getElementById('pullToRefresh');
                    pullToRefresh.innerHTML = '<span>üîÑ Refreshing...</span>';

                    setTimeout(() => {
                        pullToRefresh.classList.remove('show');
                        isPulling = false;

                        // Refresh current section
                        if (currentSection === 'home' && currentUser) {
                            loadStats();
                        }

                        showSuccess('üîÑ Refreshed!');
                    }, 1000);
                } else {
                    document.getElementById('pullToRefresh').classList.remove('show');
                    isPulling = false;
                }
            });
        }

        // Device Detection and Layout Optimization
        function detectDevice() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            const userAgent = navigator.userAgent;

            // Detect device type
            if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)) {
                if (width <= 480) {
                    deviceType = 'Mobile Phone';
                    screenSize = 'Small';
                } else if (width <= 768) {
                    deviceType = 'Mobile Tablet';
                    screenSize = 'Medium';
                } else {
                    deviceType = 'Large Tablet';
                    screenSize = 'Large';
                }
            } else {
                if (width <= 768) {
                    deviceType = 'Small Desktop';
                    screenSize = 'Medium';
                } else if (width <= 1024) {
                    deviceType = 'Desktop';
                    screenSize = 'Large';
                } else {
                    deviceType = 'Large Desktop';
                    screenSize = 'Extra Large';
                }
            }

            // Update device info display
            const deviceInfo = document.getElementById('deviceInfo');
            deviceInfo.innerHTML = `
                üì± ${deviceType} ‚Ä¢ üìè ${width}x${height} ‚Ä¢ üéØ ${screenSize} Layout
            `;

            // Show feature showcase on desktop
            if (width >= 1025) {
                const featureShowcase = document.getElementById('featureShowcase');
                featureShowcase.classList.add('show');
            }

            // Optimize layout based on device
            optimizeLayoutForDevice();
        }

        function optimizeLayoutForDevice() {
            const width = window.innerWidth;

            // Mobile optimizations
            if (width <= 480) {
                // Smaller buttons and text for mobile
                document.documentElement.style.setProperty('--button-padding', '12px');
                document.documentElement.style.setProperty('--font-size-base', '14px');

                // Hide some less important elements on very small screens
                const successMessage = document.querySelector('.success');
                if (successMessage) {
                    successMessage.style.fontSize = '0.8rem';
                }
            }

            // Tablet optimizations
            else if (width <= 768) {
                // Apply dashboard layout for tablets
                const dashboardSection = document.getElementById('dashboardSection');
                if (dashboardSection && dashboardSection.style.display !== 'none') {
                    dashboardSection.classList.add('dashboard-layout');
                }
            }

            // Desktop optimizations
            else if (width >= 1025) {
                // Apply chat layout for desktop
                const chatSection = document.getElementById('chatSection');
                if (chatSection && chatSection.style.display !== 'none') {
                    chatSection.classList.add('chat-layout');
                }
            }
        }

        // Enhanced Dashboard Layout
        function showDashboard() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';

            const userInfo = document.getElementById('userInfo');
            userInfo.innerHTML = `
                <h3>üëã Hello, ${currentUser.username}!</h3>
                <p>${getAvatarEmoji(currentUser.avatar)} ${currentUser.avatar} ‚Ä¢ ${getMoodEmoji(currentUser.mood)} ${currentUser.mood}</p>
                <p><small>Joined: ${new Date(currentUser.createdAt).toLocaleDateString()}</small></p>
            `;

            // Apply responsive layout
            optimizeLayoutForDevice();
        }

        // Enhanced Chat Interface
        function showChatInterface(partner) {
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('chatSection').style.display = 'block';

            const chatPartner = document.getElementById('chatPartner');
            chatPartner.innerHTML = `
                <h4>üí¨ Chatting with ${partner.username}</h4>
                <p>${getAvatarEmoji(partner.avatar)} Feeling ${getMoodEmoji(partner.mood)} ${partner.mood}</p>
            `;

            // Apply responsive layout
            optimizeLayoutForDevice();

            // Start polling for messages
            pollMessages();
        }

        // Responsive Window Resize Handler
        window.addEventListener('resize', () => {
            detectDevice();
            optimizeLayoutForDevice();
        });

        // Load theme preference, detect device, and request notifications
        window.addEventListener('load', () => {
            // Initialize mobile app
            initMobileApp();

            // Detect device and optimize layout
            detectDevice();

            const savedTheme = localStorage.getItem('soulconnect_theme');
            if (savedTheme === 'dark') {
                toggleTheme();
            }

            // Request notification permission after a short delay
            setTimeout(requestNotificationPermission, 2000);

            // Show welcome message
            setTimeout(() => {
                if (isMobileApp) {
                    showSuccess(`üì± Welcome to SoulConnect!\n\nYour mobile app is ready!\n\nStart by creating an account or signing in to connect with others anonymously.`);
                } else {
                    showSuccess(`üíô Welcome to SoulConnect!\n\nAnonymous friendship builder for meaningful connections.\n\nInstall as an app for the best mobile experience!`);
                }
            }, 1500);
        });

        // Check for existing session
        window.addEventListener('load', () => {
            const token = localStorage.getItem('soulconnect_token');
            const user = localStorage.getItem('soulconnect_user');

            if (token && user) {
                authToken = token;
                currentUser = JSON.parse(user);
                showDashboard();
                loadStats();
            }
        });

        // AI Chat Functions
        function startAIChat() {
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('aiChatSection').style.display = 'block';

            // Initialize AI chat with welcome message
            if (aiConversationHistory.length === 0) {
                addAIMessage('ai', getAIWelcomeMessage());
            }
        }

        function changeAIPersonality() {
            aiPersonality = document.getElementById('aiPersonalitySelect').value;
            addAIMessage('ai', getPersonalityChangeMessage());
        }

        function handleAIKeyPress(event) {
            if (event.key === 'Enter') {
                sendAIMessage();
            }
        }

        function sendQuickAIMessage(message) {
            document.getElementById('aiMessageInput').value = message;
            sendAIMessage();
        }

        async function sendAIMessage() {
            const input = document.getElementById('aiMessageInput');
            const message = input.value.trim();

            if (!message) return;

            // Add user message
            addAIMessage('user', message);
            input.value = '';

            // Show typing indicator
            showAITyping();

            // Generate AI response
            setTimeout(() => {
                hideAITyping();
                const response = generateAIResponse(message);
                addAIMessage('ai', response);
            }, 1500 + Math.random() * 1000); // Realistic response time
        }

        function addAIMessage(sender, message) {
            const messagesDiv = document.getElementById('aiChatMessages');
            const messageDiv = document.createElement('div');

            const isUser = sender === 'user';
            messageDiv.style.cssText = `
                margin-bottom: 12px;
                padding: 12px;
                border-radius: 12px;
                max-width: 80%;
                ${isUser ? 'margin-left: auto; background: #3b82f6; color: white; text-align: right;' : 'background: white; border: 1px solid #e5e7eb;'}
            `;

            const avatar = isUser ? 'üë§' : getAIAvatar();
            messageDiv.innerHTML = `
                <div style="font-size: 0.8rem; margin-bottom: 4px; opacity: 0.7;">
                    ${avatar} ${isUser ? 'You' : 'AI Companion'}
                </div>
                <div>${message}</div>
                <div style="font-size: 0.7rem; margin-top: 4px; opacity: 0.5;">
                    ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                </div>
            `;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Store in conversation history
            aiConversationHistory.push({sender, message, timestamp: Date.now()});
        }

        function showAITyping() {
            const messagesDiv = document.getElementById('aiChatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'aiTyping';
            typingDiv.style.cssText = `
                margin-bottom: 12px;
                padding: 12px;
                border-radius: 12px;
                background: white;
                border: 1px solid #e5e7eb;
                max-width: 80%;
            `;
            typingDiv.innerHTML = `
                <div style="font-size: 0.8rem; margin-bottom: 4px; opacity: 0.7;">
                    ${getAIAvatar()} AI Companion
                </div>
                <div style="display: flex; gap: 4px; align-items: center;">
                    <span>Thinking</span>
                    <div style="display: flex; gap: 2px;">
                        <div style="width: 4px; height: 4px; background: #3b82f6; border-radius: 50%; animation: pulse 1.5s infinite;"></div>
                        <div style="width: 4px; height: 4px; background: #3b82f6; border-radius: 50%; animation: pulse 1.5s infinite 0.2s;"></div>
                        <div style="width: 4px; height: 4px; background: #3b82f6; border-radius: 50%; animation: pulse 1.5s infinite 0.4s;"></div>
                    </div>
                </div>
            `;
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function hideAITyping() {
            const typingDiv = document.getElementById('aiTyping');
            if (typingDiv) typingDiv.remove();
        }

        // Enhanced OpenRouter AI Integration with Real-time Responses
        async function generateAIResponse(userMessage) {
            console.log('ü§ñ Generating AI response for:', userMessage);

            try {
                // Prepare conversation history
                const conversationMessages = [
                    {
                        role: 'system',
                        content: getAISystemPrompt()
                    }
                ];

                // Add recent conversation history (last 6 messages for context)
                const recentHistory = aiConversationHistory.slice(-6);
                recentHistory.forEach(msg => {
                    conversationMessages.push({
                        role: msg.sender === 'user' ? 'user' : 'assistant',
                        content: msg.message
                    });
                });

                // Add current user message
                conversationMessages.push({
                    role: 'user',
                    content: userMessage
                });

                console.log('üì§ Sending request to OpenRouter...');

                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer 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',
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'SoulConnect - Mental Health Companion'
                    },
                    body: JSON.stringify({
                        model: 'deepseek/deepseek-r1-0528:free',
                        messages: conversationMessages,
                        max_tokens: 250,
                        temperature: 0.8,
                        top_p: 0.9,
                        frequency_penalty: 0.1,
                        presence_penalty: 0.1
                    })
                });

                console.log('üì• Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API Error:', response.status, errorText);
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('‚úÖ AI Response received:', data);

                if (data.choices && data.choices[0] && data.choices[0].message) {
                    const aiResponse = data.choices[0].message.content.trim();
                    console.log('üéØ Final AI Response:', aiResponse);
                    return aiResponse;
                } else {
                    console.error('‚ùå Invalid response format:', data);
                    throw new Error('Invalid response format from AI');
                }

            } catch (error) {
                console.error('‚ùå AI Generation Error:', error);

                // Show error to user and provide fallback
                showError(`AI temporarily unavailable: ${error.message}\n\nUsing offline support response...`);

                return getIntelligentFallbackResponse(userMessage);
            }
        }

        function getAISystemPrompt() {
            const prompts = {
                supportive: `You are a supportive friend in a mental health app called SoulConnect. You provide understanding, caring responses to help users feel heard and supported. Keep responses warm, empathetic, and under 150 words. Focus on validation and gentle encouragement.`,

                professional: `You are a professional counselor in SoulConnect, a mental health app. Provide structured, evidence-based guidance while maintaining warmth. Use therapeutic techniques and ask thoughtful questions. Keep responses professional yet caring, under 150 words.`,

                empathetic: `You are an empathetic listener in SoulConnect. Your role is to provide deep emotional support and understanding. Reflect feelings, validate experiences, and offer comfort. Be deeply caring and intuitive in your responses, under 150 words.`,

                motivational: `You are a motivational coach in SoulConnect. Provide encouraging, uplifting responses that inspire hope and action. Focus on strengths, possibilities, and positive reframing. Be energetic yet sensitive, under 150 words.`
            };

            return prompts[aiPersonality] || prompts.supportive;
        }

        function getIntelligentFallbackResponse(userMessage) {
            console.log('üîÑ Using intelligent fallback for:', userMessage);

            // More sophisticated fallback responses based on message analysis
            const lowerMessage = userMessage.toLowerCase();
            const messageLength = userMessage.length;
            const timeOfDay = new Date().getHours();

            // Analyze message sentiment and keywords
            const keywords = {
                anxiety: ['anxious', 'worried', 'nervous', 'panic', 'stress', 'overwhelmed', 'scared'],
                depression: ['sad', 'depressed', 'down', 'hopeless', 'empty', 'worthless', 'tired'],
                loneliness: ['lonely', 'alone', 'isolated', 'nobody', 'friends', 'connection'],
                anger: ['angry', 'mad', 'frustrated', 'annoyed', 'furious', 'hate'],
                gratitude: ['thank', 'grateful', 'appreciate', 'blessed', 'happy'],
                crisis: ['suicide', 'kill myself', 'end it', 'hurt myself', 'die', 'can\'t go on'],
                greeting: ['hello', 'hi', 'hey', 'good morning', 'good evening'],
                question: ['?', 'how', 'what', 'why', 'when', 'where', 'can you']
            };

            let detectedEmotion = 'neutral';
            let maxMatches = 0;

            for (const [emotion, words] of Object.entries(keywords)) {
                const matches = words.filter(word => lowerMessage.includes(word)).length;
                if (matches > maxMatches) {
                    maxMatches = matches;
                    detectedEmotion = emotion;
                }
            }

            // Crisis detection
            if (detectedEmotion === 'crisis') {
                return "I'm very concerned about what you're sharing. Your life has value and you matter. Please reach out for immediate help:\n\nüÜò National Suicide Prevention Lifeline: 988\nüì± Crisis Text Line: Text HOME to 741741\n\nI'm here to support you, but please connect with professional crisis support right away. You don't have to go through this alone. üíô";
            }

            // Generate contextual response
            const responses = {
                anxiety: [
                    `I can hear the anxiety in your message. It's completely understandable to feel this way. Let's try a quick grounding technique: name 3 things you can see right now, 2 things you can hear, and 1 thing you can touch. This can help bring you back to the present moment. üå±`,
                    `Anxiety can feel so overwhelming, but remember - you've survived 100% of your difficult days so far. That's a pretty good track record. What's one small thing you can do right now to feel even 1% calmer? üíô`,
                    `I notice you're feeling anxious. Your nervous system is trying to protect you, but sometimes it gets a bit overactive. Try breathing in for 4 counts, holding for 4, and out for 6. You're safe right now. ü´Å`
                ],
                depression: [
                    `I hear the heaviness in your words, and I want you to know that what you're feeling is valid. Depression can make everything feel harder, but you're still here, and that takes incredible strength. What's one tiny thing that brought you even a moment of peace today? üåô`,
                    `Thank you for sharing something so difficult. Depression lies to us and tells us we're alone, but you're not. Even reaching out here shows your courage. Be gentle with yourself today - you're doing better than you think. üíú`,
                    `I can feel the weight you're carrying. Some days, just getting through is enough. You don't have to be productive or positive right now. Just being here, just surviving, is enough. What would feel most supportive right now? ü§ó`
                ],
                loneliness: [
                    `Loneliness is one of the hardest feelings to sit with. I want you to know that even though we're not physically together, I'm here with you in this moment. Your feelings matter, and you matter. What's one small way you could connect with someone today, even briefly? üíô`,
                    `I hear how isolated you're feeling. Loneliness doesn't mean you're unlovable - it means you're human and need connection, which is completely normal. Sometimes even small interactions, like chatting here, can help. You're not as alone as you feel. üåü`,
                    `The loneliness you're describing sounds really painful. Remember that feeling lonely doesn't mean you ARE alone - sometimes our minds play tricks on us. You reached out here, which shows your strength. What would help you feel even slightly more connected? ü§ó`
                ],
                anger: [
                    `I can sense the frustration and anger in your message. Those are completely valid emotions - anger often tells us that something important to us has been threatened or hurt. It's okay to feel this way. What do you think your anger is trying to tell you? üî•`,
                    `Anger can be such a powerful emotion. Sometimes it's our way of protecting ourselves when we feel hurt or powerless. It's okay to feel angry - the question is how we can channel it in a way that helps rather than hurts. What would feel good to do with this energy? üí™`,
                    `I hear the intensity in your words. Anger is often a secondary emotion - sometimes there's hurt, fear, or disappointment underneath. Whatever you're feeling is valid. How can we help you process this in a healthy way? üå±`
                ],
                gratitude: [
                    `I love hearing the gratitude in your message! It's beautiful when we can notice the good things, even in difficult times. Gratitude has this amazing way of shifting our perspective. What else are you feeling grateful for today? ‚ú®`,
                    `Your appreciation really warms my heart. It takes wisdom to recognize and express gratitude. These positive moments are worth celebrating and holding onto. How does it feel to focus on what's going well? üåü`,
                    `Thank you for sharing something positive! Gratitude is like a muscle - the more we use it, the stronger it gets. It's wonderful that you're taking time to notice the good things. What made you smile today? üòä`
                ],
                greeting: [
                    `Hello! It's wonderful to meet you. I'm here to listen, support, and chat about whatever's on your mind. Whether you're having a great day or a tough one, I'm glad you're here. How are you feeling today? üíô`,
                    `Hi there! Welcome to our conversation. I'm your AI companion, and I'm here to provide support, understanding, and a listening ear. What would you like to talk about today? üåü`,
                    `Hey! Thanks for reaching out. I'm here to support you through whatever you're experiencing. Whether you need someone to listen, want to explore your feelings, or just need a friendly chat, I'm here. What's on your mind? ü§ó`
                ],
                question: [
                    `That's a thoughtful question! I appreciate your curiosity. Let me think about that with you. ${generateContextualQuestionResponse(userMessage)} What are your thoughts on this? ü§î`,
                    `Great question! I love when people are curious and want to explore ideas. ${generateContextualQuestionResponse(userMessage)} How does this relate to what you're experiencing? üí≠`,
                    `I'm glad you asked! Questions help us learn and grow. ${generateContextualQuestionResponse(userMessage)} What made you curious about this? üå±`
                ],
                neutral: [
                    `Thank you for sharing that with me. I'm here to listen and support you, whatever you're going through. Your thoughts and feelings matter. What would be most helpful for you right now? üíô`,
                    `I appreciate you opening up. Everyone's experience is unique and valid. Whether you're having a good day or struggling, I'm here to support you. How are you taking care of yourself today? üåü`,
                    `I'm glad you're here. Sometimes it helps just to have someone to talk to, even if it's an AI. I'm here to listen without judgment and offer support. What's been on your mind lately? ü§ó`
                ]
            };

            // Add time-based context
            let timeContext = '';
            if (timeOfDay < 6) {
                timeContext = ' I notice it\'s quite late/early - sometimes our thoughts feel heavier in the quiet hours. ';
            } else if (timeOfDay < 12) {
                timeContext = ' I hope your morning is treating you gently. ';
            } else if (timeOfDay < 18) {
                timeContext = ' I hope your day is going okay so far. ';
            } else {
                timeContext = ' I hope your evening is peaceful. ';
            }

            const responseArray = responses[detectedEmotion] || responses.neutral;
            let response = responseArray[Math.floor(Math.random() * responseArray.length)];

            // Add personalization based on message length
            if (messageLength > 100) {
                response += '\n\nI can see you\'ve shared a lot with me. Thank you for trusting me with your thoughts.';
            }

            return response + timeContext;
        }

        function generateContextualQuestionResponse(question) {
            const lowerQ = question.toLowerCase();
            if (lowerQ.includes('how') && lowerQ.includes('feel')) {
                return 'Feelings can be complex and change throughout the day. It\'s normal to experience a mix of emotions.';
            } else if (lowerQ.includes('why') && (lowerQ.includes('sad') || lowerQ.includes('depressed'))) {
                return 'Sadness and depression can have many causes - sometimes it\'s situational, sometimes chemical, often a combination.';
            } else if (lowerQ.includes('what') && lowerQ.includes('do')) {
                return 'There are many approaches we can explore together, depending on what feels right for you.';
            } else {
                return 'That\'s something worth exploring together.';
            }
        }

        function detectMessageType(message) {
            const lowerMessage = message.toLowerCase();
            if (lowerMessage.includes('anxious') || lowerMessage.includes('anxiety') || lowerMessage.includes('worried')) return 'anxious';
            if (lowerMessage.includes('lonely') || lowerMessage.includes('alone') || lowerMessage.includes('isolated')) return 'lonely';
            if (lowerMessage.includes('sad') || lowerMessage.includes('depressed') || lowerMessage.includes('down')) return 'sad';
            return 'default';
        }

        function getAIWelcomeMessage() {
            const welcomes = {
                supportive: "Hi there! üíô I'm your AI companion, here to listen and support you. Feel free to share whatever's on your mind - I'm here for you.",
                professional: "Hello! I'm your AI counselor. I'm here to provide guidance and support in a safe, confidential space. What would you like to talk about today?",
                empathetic: "Welcome! ü§ó I'm here to listen with an open heart. Whatever you're feeling or experiencing, you can share it with me. You're not alone.",
                motivational: "Hey there! ‚ö° I'm your motivational companion, ready to help you find your strength and potential. What's on your mind today?"
            };
            return welcomes[aiPersonality] || welcomes.supportive;
        }

        function getPersonalityChangeMessage() {
            return `I've switched to ${aiPersonality} mode. How can I best support you today? üåü`;
        }

        function getAIAvatar() {
            const avatars = {
                supportive: 'üíô',
                professional: 'üéØ',
                empathetic: 'ü§ó',
                motivational: '‚ö°'
            };
            return avatars[aiPersonality] || 'ü§ñ';
        }

        // Professional Features
        function showWellnessCenter() {
            document.getElementById('dashboardSection').style.display = 'none';

            const wellnessHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #1f2937; margin: 0;">üå± Wellness Center</h2>
                        <button onclick="showDashboard()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úï</button>
                    </div>

                    <div style="display: grid; gap: 16px;">
                        <div class="wellness-card" onclick="startBreathingExercise()">
                            <div style="font-size: 2rem; margin-bottom: 8px;">ü´Å</div>
                            <h3>Breathing Exercise</h3>
                            <p>Calm your mind with guided breathing</p>
                        </div>

                        <div class="wellness-card" onclick="showMeditation()">
                            <div style="font-size: 2rem; margin-bottom: 8px;">üßò</div>
                            <h3>Meditation Guide</h3>
                            <p>5-minute mindfulness session</p>
                        </div>

                        <div class="wellness-card" onclick="showCopingStrategies()">
                            <div style="font-size: 2rem; margin-bottom: 8px;">üõ°Ô∏è</div>
                            <h3>Coping Strategies</h3>
                            <p>Tools for difficult moments</p>
                        </div>

                        <div class="wellness-card" onclick="showCrisisResources()">
                            <div style="font-size: 2rem; margin-bottom: 8px;">üÜò</div>
                            <h3>Crisis Support</h3>
                            <p>Immediate help resources</p>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', `<div id="wellnessSection">${wellnessHTML}</div>`);
        }

        function showJournal() {
            document.getElementById('dashboardSection').style.display = 'none';

            const journalHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #1f2937; margin: 0;">üìù Personal Journal</h2>
                        <button onclick="showDashboard()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úï</button>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">How are you feeling today?</label>
                        <textarea id="journalEntry" placeholder="Write about your thoughts, feelings, or experiences..." style="width: 100%; height: 150px; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; resize: vertical;"></textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                        <button onclick="saveJournalEntry()" class="button" style="background: #10b981;">üíæ Save Entry</button>
                        <button onclick="viewJournalHistory()" class="button" style="background: #8b5cf6;">üìö View History</button>
                    </div>

                    <div style="text-align: center; color: #6b7280; font-size: 0.9rem;">
                        Your journal is private and secure üîí
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', `<div id="journalSection">${journalHTML}</div>`);
        }

        function showMoodTracker() {
            document.getElementById('dashboardSection').style.display = 'none';

            const moodHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #1f2937; margin: 0;">üìä Mood Insights</h2>
                        <button onclick="showDashboard()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úï</button>
                    </div>

                    <div style="text-align: center; margin-bottom: 20px;">
                        <h3>Your Mood This Week</h3>
                        <div style="display: flex; justify-content: space-around; margin: 20px 0;">
                            <div style="text-align: center;">
                                <div style="font-size: 2rem;">üòä</div>
                                <div style="font-size: 0.8rem;">Mon</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem;">üòî</div>
                                <div style="font-size: 0.8rem;">Tue</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem;">üò∞</div>
                                <div style="font-size: 0.8rem;">Wed</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem;">ü§ó</div>
                                <div style="font-size: 0.8rem;">Thu</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem;">üòä</div>
                                <div style="font-size: 0.8rem;">Today</div>
                            </div>
                        </div>
                    </div>

                    <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <h4 style="margin: 0 0 8px 0;">üí° Insights</h4>
                        <p style="margin: 0; font-size: 0.9rem; color: #6b7280;">
                            You've been feeling better this week! Your mood improved after chatting with friends.
                            Keep connecting with others! üåü
                        </p>
                    </div>

                    <button onclick="logMoodToday()" class="button" style="background: #3b82f6; width: 100%;">
                        üìù Log Today's Mood
                    </button>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', `<div id="moodSection">${moodHTML}</div>`);
        }

        // Enhanced Dashboard Navigation
        function showDashboard() {
            // Hide all sections
            const sections = ['chatSection', 'aiChatSection', 'wellnessSection', 'journalSection', 'moodSection'];
            sections.forEach(section => {
                const element = document.getElementById(section);
                if (element) {
                    element.style.display = 'none';
                    if (section.includes('wellness') || section.includes('journal') || section.includes('mood')) {
                        element.remove(); // Remove dynamic sections
                    }
                }
            });

            // Show dashboard
            document.getElementById('dashboardSection').style.display = 'block';
            stopMessagePolling();
        }

        // Enhanced AI Chat Integration
        async function sendAIMessage() {
            const input = document.getElementById('aiMessageInput');
            const message = input.value.trim();

            if (!message) return;

            // Add user message
            addAIMessage('user', message);
            input.value = '';

            // Show typing indicator
            showAITyping();

            // Generate AI response using OpenRouter
            try {
                const response = await generateAIResponse(message);
                hideAITyping();
                addAIMessage('ai', response);
            } catch (error) {
                hideAITyping();
                addAIMessage('ai', 'I apologize, but I\'m having trouble connecting right now. Please try again in a moment. üíô');
            }
        }

        // Fix Anonymous Chat Function
        async function startChat() {
            if (!currentUser) {
                showError('Please login first to start chatting!');
                return;
            }

            try {
                showSuccess('üîç Looking for someone to chat with...\n\nSearching for available users...');

                const response = await apiCall('/api/chat/start', 'POST');

                if (response.success) {
                    currentChatRoom = response.chatRoom;
                    document.getElementById('dashboardSection').style.display = 'none';
                    document.getElementById('chatSection').style.display = 'block';

                    // Update chat partner info
                    const partnerInfo = document.getElementById('chatPartner');
                    partnerInfo.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                            <div style="font-size: 2rem;">${getAvatarEmoji(response.partner.avatar)}</div>
                            <div>
                                <div style="font-weight: 600; color: #1f2937;">Anonymous Friend</div>
                                <div style="font-size: 0.9rem; color: #6b7280;">Mood: ${getMoodEmoji(response.partner.mood)} ${response.partner.mood}</div>
                                <div style="font-size: 0.8rem; color: #10b981;">‚óè Online</div>
                            </div>
                        </div>
                    `;

                    // Start polling for messages
                    startMessagePolling();

                    showSuccess('üéâ Connected! You can now chat anonymously.\n\nBe kind and respectful! üíô');
                } else {
                    showError(response.message || 'No users available right now. Try again in a moment!');
                }
            } catch (error) {
                showError('Connection failed. Please check your internet and try again.');
            }
        }

        // Message Polling for Real-time Chat
        function startMessagePolling() {
            if (messagePolling) clearInterval(messagePolling);

            messagePolling = setInterval(async () => {
                if (currentChatRoom) {
                    await pollMessages();
                }
            }, 2000); // Poll every 2 seconds
        }

        function stopMessagePolling() {
            if (messagePolling) {
                clearInterval(messagePolling);
                messagePolling = null;
            }
        }

        // Helper Functions
        function getAvatarEmoji(avatar) {
            const avatars = {
                fox: 'ü¶ä', cat: 'üê±', dog: 'üê∂',
                bear: 'üêª', rabbit: 'üê∞'
            };
            return avatars[avatar] || 'üê±';
        }

        function getMoodEmoji(mood) {
            const moods = {
                happy: 'üòä', sad: 'üò¢', anxious: 'üò∞',
                lonely: 'üòî', excited: 'ü§ó'
            };
            return moods[mood] || 'üòä';
        }

        // Show Chat Section
        function showChat() {
            if (!currentUser) {
                showError('Please login first!');
                return;
            }

            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('chatSection').style.display = 'block';
        }

        // Close Chat and Return to Dashboard
        function closeChatSection() {
            stopMessagePolling();
            currentChatRoom = null;
            document.getElementById('chatSection').style.display = 'none';
            document.getElementById('aiChatSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
        }

        // Wellness Feature Functions
        function startBreathingExercise() {
            // Create breathing exercise interface
            const breathingHTML = `
                <div class="card" style="text-align: center; background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%);">
                    <h2 style="margin-bottom: 20px;">ü´Å Breathing Exercise</h2>
                    <div id="breathingCircle" style="width: 150px; height: 150px; border: 4px solid #2196f3; border-radius: 50%; margin: 20px auto; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; transition: all 4s ease;"></div>
                    <div id="breathingText" style="font-size: 1.5rem; margin: 20px 0; color: #1976d2;"></div>
                    <div id="breathingCounter" style="font-size: 1rem; color: #666; margin-bottom: 20px;"></div>
                    <button onclick="stopBreathing()" class="button" style="background: #f44336;">Stop Exercise</button>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', `<div id="breathingSection">${breathingHTML}</div>`);
            document.getElementById('dashboardSection').style.display = 'none';

            let cycle = 0;
            let phase = 0;
            const phases = [
                { text: 'Breathe In', duration: 4000, scale: 1.3 },
                { text: 'Hold', duration: 2000, scale: 1.3 },
                { text: 'Breathe Out', duration: 4000, scale: 1 },
                { text: 'Hold', duration: 2000, scale: 1 }
            ];

            function runBreathingCycle() {
                if (cycle >= 5) {
                    showSuccess('üåü Excellent! You completed 5 breathing cycles.\n\nNotice how your body feels now. Regular breathing exercises can reduce anxiety and improve focus.');
                    stopBreathing();
                    return;
                }

                const currentPhase = phases[phase];
                const circle = document.getElementById('breathingCircle');
                const text = document.getElementById('breathingText');
                const counter = document.getElementById('breathingCounter');

                if (circle && text && counter) {
                    text.textContent = currentPhase.text;
                    counter.textContent = `Cycle ${cycle + 1} of 5`;
                    circle.style.transform = `scale(${currentPhase.scale})`;
                    circle.style.backgroundColor = phase % 2 === 0 ? '#e3f2fd' : '#bbdefb';

                    setTimeout(() => {
                        phase++;
                        if (phase >= 4) {
                            phase = 0;
                            cycle++;
                        }
                        runBreathingCycle();
                    }, currentPhase.duration);
                }
            }

            runBreathingCycle();
        }

        function stopBreathing() {
            const section = document.getElementById('breathingSection');
            if (section) section.remove();
            showDashboard();
        }

        function showMeditation() {
            const meditationHTML = `
                <div class="card" style="text-align: center; background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);">
                    <h2 style="margin-bottom: 20px;">üßò 5-Minute Meditation</h2>
                    <div id="meditationTimer" style="font-size: 3rem; color: #7b1fa2; margin: 30px 0; font-weight: bold;">5:00</div>
                    <div id="meditationPhase" style="font-size: 1.3rem; color: #4a148c; margin: 20px 0;">Get comfortable and close your eyes</div>
                    <div style="margin: 20px 0;">
                        <button id="startMeditationBtn" onclick="startMeditationTimer()" class="button" style="background: #9c27b0; margin-right: 10px;">Start Meditation</button>
                        <button onclick="stopMeditation()" class="button" style="background: #f44336;">End Session</button>
                    </div>
                    <div style="background: rgba(255,255,255,0.7); padding: 15px; border-radius: 8px; margin-top: 20px; text-align: left;">
                        <h4 style="margin: 0 0 10px 0;">Meditation Guide:</h4>
                        <p style="margin: 5px 0;">‚Ä¢ Find a quiet, comfortable position</p>
                        <p style="margin: 5px 0;">‚Ä¢ Close your eyes gently</p>
                        <p style="margin: 5px 0;">‚Ä¢ Focus on your natural breathing</p>
                        <p style="margin: 5px 0;">‚Ä¢ When thoughts arise, acknowledge them and return to breath</p>
                        <p style="margin: 5px 0;">‚Ä¢ Be patient and kind with yourself</p>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', `<div id="meditationSection">${meditationHTML}</div>`);
            document.getElementById('dashboardSection').style.display = 'none';
        }

        function startMeditationTimer() {
            let timeLeft = 300; // 5 minutes in seconds
            const timer = document.getElementById('meditationTimer');
            const phase = document.getElementById('meditationPhase');
            const startBtn = document.getElementById('startMeditationBtn');

            if (startBtn) startBtn.style.display = 'none';

            const phases = [
                { time: 300, text: "Begin by taking three deep breaths..." },
                { time: 270, text: "Notice your natural breathing rhythm..." },
                { time: 240, text: "Feel your body relaxing with each breath..." },
                { time: 180, text: "If thoughts arise, gently return to your breath..." },
                { time: 120, text: "You're doing great. Stay present..." },
                { time: 60, text: "One more minute. Feel the calm..." },
                { time: 30, text: "Prepare to slowly return to awareness..." },
                { time: 0, text: "Gently open your eyes. Well done! üåü" }
            ];

            const interval = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;

                if (timer) {
                    timer.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }

                // Update phase text
                const currentPhase = phases.find(p => timeLeft <= p.time);
                if (currentPhase && phase) {
                    phase.textContent = currentPhase.text;
                }

                if (timeLeft <= 0) {
                    clearInterval(interval);
                    showSuccess('üåü Meditation Complete!\n\nYou\'ve successfully completed a 5-minute meditation session. Notice how you feel now compared to when you started.\n\nRegular meditation can reduce stress, improve focus, and enhance emotional well-being.');
                    setTimeout(() => stopMeditation(), 3000);
                    return;
                }

                timeLeft--;
            }, 1000);
        }

        function stopMeditation() {
            const section = document.getElementById('meditationSection');
            if (section) section.remove();
            showDashboard();
        }

        function showCopingStrategies() {
            const copingHTML = `
                <div class="card" style="background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2e7d32; margin: 0;">üõ°Ô∏è Coping Strategies</h2>
                        <button onclick="closeCoping()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úï</button>
                    </div>

                    <div style="display: grid; gap: 15px;">
                        <div class="coping-card" onclick="start54321()">
                            <h3>üéØ 5-4-3-2-1 Grounding</h3>
                            <p>Immediate anxiety relief technique</p>
                        </div>

                        <div class="coping-card" onclick="showProgressiveMuscle()">
                            <h3>üí™ Progressive Muscle Relaxation</h3>
                            <p>Release physical tension step by step</p>
                        </div>

                        <div class="coping-card" onclick="showPositiveAffirmations()">
                            <h3>‚ú® Positive Affirmations</h3>
                            <p>Boost self-esteem and confidence</p>
                        </div>

                        <div class="coping-card" onclick="showDistraction()">
                            <h3>üé® Healthy Distractions</h3>
                            <p>Redirect focus to positive activities</p>
                        </div>

                        <div class="coping-card" onclick="showEmotionalRegulation()">
                            <h3>üß† Emotional Regulation</h3>
                            <p>Understand and manage emotions</p>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', `<div id="copingSection">${copingHTML}</div>`);
            document.getElementById('dashboardSection').style.display = 'none';
        }

        function start54321() {
            let step = 0;
            const steps = [
                { count: 5, sense: "things you can SEE", icon: "üëÄ" },
                { count: 4, sense: "things you can HEAR", icon: "üëÇ" },
                { count: 3, sense: "things you can TOUCH", icon: "‚úã" },
                { count: 2, sense: "things you can SMELL", icon: "üëÉ" },
                { count: 1, sense: "thing you can TASTE", icon: "üëÖ" }
            ];

            function nextStep() {
                if (step >= steps.length) {
                    showSuccess('üåü Grounding Complete!\n\nYou\'ve successfully completed the 5-4-3-2-1 grounding technique. This helps bring you back to the present moment and can reduce anxiety.\n\nHow do you feel now?');
                    return;
                }

                const current = steps[step];
                const message = `${current.icon} 5-4-3-2-1 Grounding\n\nStep ${step + 1} of 5\n\nName ${current.count} ${current.sense}\n\nTake your time and really focus on each one...`;

                if (confirm(message + '\n\nClick OK when ready for next step, or Cancel to stop.')) {
                    step++;
                    setTimeout(nextStep, 1000);
                } else {
                    showSuccess('Grounding exercise stopped. Even partial grounding can be helpful! üíô');
                }
            }

            nextStep();
        }

        function showProgressiveMuscle() {
            showSuccess('üí™ Progressive Muscle Relaxation\n\n1. Start with your toes - tense for 5 seconds, then relax\n2. Move to your calves - tense and relax\n3. Thighs - tense and relax\n4. Abdomen - tense and relax\n5. Hands - make fists, then relax\n6. Arms - tense and relax\n7. Shoulders - raise to ears, then relax\n8. Face - scrunch up, then relax\n\nNotice the difference between tension and relaxation.');
        }

        function showPositiveAffirmations() {
            const affirmations = [
                "I am stronger than my challenges",
                "This feeling is temporary and will pass",
                "I deserve love and kindness",
                "I am capable of handling whatever comes my way",
                "I choose peace over worry",
                "I am worthy of good things",
                "I trust in my ability to overcome difficulties",
                "I am enough, just as I am"
            ];

            const randomAffirmation = affirmations[Math.floor(Math.random() * affirmations.length)];
            showSuccess(`‚ú® Your Affirmation Today:\n\n"${randomAffirmation}"\n\nRepeat this to yourself throughout the day. Positive self-talk can rewire your brain for resilience and self-compassion.`);
        }

        function showDistraction() {
            showSuccess('üé® Healthy Distractions\n\n‚Ä¢ Listen to your favorite music\n‚Ä¢ Draw, paint, or color\n‚Ä¢ Take a walk in nature\n‚Ä¢ Call a friend or family member\n‚Ä¢ Watch funny videos\n‚Ä¢ Do a puzzle or brain game\n‚Ä¢ Cook or bake something\n‚Ä¢ Practice a hobby\n‚Ä¢ Read a book\n‚Ä¢ Take a warm bath\n\nChoose activities that bring you joy and peace.');
        }

        function showEmotionalRegulation() {
            showSuccess('üß† Emotional Regulation\n\n1. PAUSE - Take a moment before reacting\n2. IDENTIFY - What emotion am I feeling?\n3. ACCEPT - It\'s okay to feel this way\n4. UNDERSTAND - What triggered this emotion?\n5. CHOOSE - How do I want to respond?\n6. ACT - Take a healthy action\n\nRemember: You can\'t control what you feel, but you can control how you respond.');
        }

        function closeCoping() {
            const section = document.getElementById('copingSection');
            if (section) section.remove();
            showDashboard();
        }

        function showCrisisResources() {
            showSuccess('üÜò Crisis Support Resources\n\n‚Ä¢ National Suicide Prevention Lifeline: 988\n‚Ä¢ Crisis Text Line: Text HOME to 741741\n‚Ä¢ International Association for Suicide Prevention: iasp.info\n‚Ä¢ Your local emergency services: 911\n\nYou matter. Your life has value. Help is available 24/7. üíô');
        }

        function saveJournalEntry() {
            const entry = document.getElementById('journalEntry').value.trim();
            if (entry) {
                // Save to localStorage and backend
                const entries = JSON.parse(localStorage.getItem('journalEntries') || '[]');
                const newEntry = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    entry: entry,
                    mood: currentUser?.mood || 'neutral',
                    tags: extractTags(entry),
                    wordCount: entry.split(' ').length
                };
                entries.push(newEntry);
                localStorage.setItem('journalEntries', JSON.stringify(entries));

                // Update mood based on entry sentiment
                updateMoodFromEntry(entry);

                showSuccess('üíæ Journal entry saved!\n\nWriting about your feelings can help process emotions and track your mental health journey.\n\nWords written: ' + newEntry.wordCount);
                document.getElementById('journalEntry').value = '';

                // Show writing streak
                showWritingStreak();
            } else {
                showError('Please write something in your journal first!');
            }
        }

        function viewJournalHistory() {
            const entries = JSON.parse(localStorage.getItem('journalEntries') || '[]');
            if (entries.length === 0) {
                showSuccess('üìö Journal History\n\nNo entries yet. Start writing to track your mental health journey!');
                return;
            }

            const historyHTML = `
                <div class="card" style="max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #1f2937; margin: 0;">üìö Journal History</h2>
                        <button onclick="closeJournalHistory()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úï</button>
                    </div>

                    <div style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <h4 style="margin: 0 0 10px 0;">üìä Your Writing Stats</h4>
                        <p style="margin: 5px 0;">Total entries: ${entries.length}</p>
                        <p style="margin: 5px 0;">Words written: ${entries.reduce((sum, e) => sum + (e.wordCount || 0), 0)}</p>
                        <p style="margin: 5px 0;">Writing streak: ${getWritingStreak()} days</p>
                    </div>

                    <div style="display: grid; gap: 15px;">
                        ${entries.slice(-10).reverse().map(entry => `
                            <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-weight: 500; color: #1f2937;">${new Date(entry.date).toLocaleDateString()}</span>
                                    <span style="font-size: 0.9rem; color: #6b7280;">${getMoodEmoji(entry.mood)} ${entry.mood}</span>
                                </div>
                                <p style="margin: 0; color: #374151; line-height: 1.5;">${entry.entry}</p>
                                ${entry.tags ? `<div style="margin-top: 8px;">${entry.tags.map(tag => `<span style="background: #e0e7ff; color: #3730a3; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-right: 5px;">#${tag}</span>`).join('')}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', `<div id="journalHistorySection">${historyHTML}</div>`);
        }

        function extractTags(entry) {
            const keywords = {
                'anxiety': ['anxious', 'worried', 'nervous', 'stress'],
                'happiness': ['happy', 'joy', 'excited', 'good', 'great'],
                'sadness': ['sad', 'down', 'depressed', 'low'],
                'gratitude': ['grateful', 'thankful', 'blessed', 'appreciate'],
                'work': ['job', 'work', 'career', 'boss', 'office'],
                'relationships': ['friend', 'family', 'love', 'relationship'],
                'health': ['health', 'exercise', 'sleep', 'tired']
            };

            const tags = [];
            const lowerEntry = entry.toLowerCase();

            for (const [tag, words] of Object.entries(keywords)) {
                if (words.some(word => lowerEntry.includes(word))) {
                    tags.push(tag);
                }
            }

            return tags;
        }

        function updateMoodFromEntry(entry) {
            const positiveWords = ['happy', 'good', 'great', 'excited', 'joy', 'love', 'grateful'];
            const negativeWords = ['sad', 'bad', 'terrible', 'anxious', 'worried', 'depressed'];

            const lowerEntry = entry.toLowerCase();
            const positiveCount = positiveWords.filter(word => lowerEntry.includes(word)).length;
            const negativeCount = negativeWords.filter(word => lowerEntry.includes(word)).length;

            if (positiveCount > negativeCount) {
                // Suggest mood update to positive
                setTimeout(() => {
                    if (confirm('Your journal entry seems positive! Would you like to update your mood to reflect this?')) {
                        updateMood('happy', 'üòä');
                    }
                }, 2000);
            }
        }

        function getWritingStreak() {
            const entries = JSON.parse(localStorage.getItem('journalEntries') || '[]');
            if (entries.length === 0) return 0;

            let streak = 0;
            const today = new Date();

            for (let i = 0; i < 30; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(today.getDate() - i);
                const dateStr = checkDate.toDateString();

                const hasEntry = entries.some(entry =>
                    new Date(entry.date).toDateString() === dateStr
                );

                if (hasEntry) {
                    streak++;
                } else if (i > 0) {
                    break;
                }
            }

            return streak;
        }

        function showWritingStreak() {
            const streak = getWritingStreak();
            if (streak > 1) {
                showSuccess(`üî• Writing Streak: ${streak} days!\n\nKeep it up! Consistent journaling is great for mental health.`);
            }
        }

        function closeJournalHistory() {
            const section = document.getElementById('journalHistorySection');
            if (section) section.remove();
        }

        function logMoodToday() {
            const moodLogHTML = `
                <div class="card" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #e65100; margin: 0;">üìù Log Your Mood</h2>
                        <button onclick="closeMoodLog()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úï</button>
                    </div>

                    <div style="text-align: center; margin-bottom: 20px;">
                        <h3>How are you feeling right now?</h3>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div class="mood-option" onclick="logMood('happy', 'üòä', 'Happy')">
                            <div style="font-size: 3rem;">üòä</div>
                            <div style="font-weight: 500;">Happy</div>
                        </div>
                        <div class="mood-option" onclick="logMood('excited', 'ü§ó', 'Excited')">
                            <div style="font-size: 3rem;">ü§ó</div>
                            <div style="font-weight: 500;">Excited</div>
                        </div>
                        <div class="mood-option" onclick="logMood('neutral', 'üòê', 'Neutral')">
                            <div style="font-size: 3rem;">üòê</div>
                            <div style="font-weight: 500;">Neutral</div>
                        </div>
                        <div class="mood-option" onclick="logMood('anxious', 'üò∞', 'Anxious')">
                            <div style="font-size: 3rem;">üò∞</div>
                            <div style="font-weight: 500;">Anxious</div>
                        </div>
                        <div class="mood-option" onclick="logMood('sad', 'üòî', 'Sad')">
                            <div style="font-size: 3rem;">üòî</div>
                            <div style="font-weight: 500;">Sad</div>
                        </div>
                        <div class="mood-option" onclick="logMood('lonely', 'üòî', 'Lonely')">
                            <div style="font-size: 3rem;">üòî</div>
                            <div style="font-weight: 500;">Lonely</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">What's influencing your mood? (Optional)</label>
                        <textarea id="moodNote" placeholder="Work, relationships, health, weather, etc..." style="width: 100%; height: 60px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;"></textarea>
                    </div>

                    <div style="text-align: center; color: #6b7280; font-size: 0.9rem;">
                        Regular mood tracking helps identify patterns and triggers
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', `<div id="moodLogSection">${moodLogHTML}</div>`);
        }

        function logMood(mood, emoji, label) {
            const note = document.getElementById('moodNote')?.value || '';

            // Save mood log
            const moodLogs = JSON.parse(localStorage.getItem('moodLogs') || '[]');
            const newLog = {
                date: new Date().toISOString(),
                mood: mood,
                emoji: emoji,
                label: label,
                note: note,
                timestamp: Date.now()
            };
            moodLogs.push(newLog);
            localStorage.setItem('moodLogs', JSON.stringify(moodLogs));

            // Update current user mood
            if (currentUser) {
                currentUser.mood = mood;
                localStorage.setItem('soulconnect_user', JSON.stringify(currentUser));
                updateMood(mood, emoji);
            }

            // Close mood log
            closeMoodLog();

            // Show confirmation with insights
            const recentMoods = moodLogs.slice(-7);
            const moodCounts = {};
            recentMoods.forEach(log => {
                moodCounts[log.mood] = (moodCounts[log.mood] || 0) + 1;
            });

            const dominantMood = Object.keys(moodCounts).reduce((a, b) =>
                moodCounts[a] > moodCounts[b] ? a : b
            );

            let insight = '';
            if (recentMoods.length >= 3) {
                if (dominantMood === 'happy' || dominantMood === 'excited') {
                    insight = '\n\nüåü You\'ve been feeling positive lately! Keep doing what makes you happy.';
                } else if (dominantMood === 'anxious' || dominantMood === 'sad') {
                    insight = '\n\nüíô I notice you\'ve been having some difficult days. Consider talking to someone or trying our wellness tools.';
                } else {
                    insight = '\n\nüìä Your mood has been varied lately. That\'s completely normal!';
                }
            }

            showSuccess(`${emoji} Mood logged: ${label}\n\nThank you for tracking your emotional well-being!${insight}`);
        }

        function closeMoodLog() {
            const section = document.getElementById('moodLogSection');
            if (section) section.remove();
        }

        // Enhanced Mood Tracker with Real Data
        function showMoodTracker() {
            const moodLogs = JSON.parse(localStorage.getItem('moodLogs') || '[]');
            const last7Days = getLast7DaysMoods(moodLogs);

            const moodHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #1f2937; margin: 0;">üìä Mood Insights</h2>
                        <button onclick="closeMoodTracker()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úï</button>
                    </div>

                    <div style="text-align: center; margin-bottom: 20px;">
                        <h3>Your Mood This Week</h3>
                        <div style="display: flex; justify-content: space-around; margin: 20px 0;">
                            ${last7Days.map(day => `
                                <div style="text-align: center;">
                                    <div style="font-size: 2rem;">${day.emoji}</div>
                                    <div style="font-size: 0.8rem; color: #6b7280;">${day.day}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    ${generateMoodInsights(moodLogs)}

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px;">
                        <button onclick="logMoodToday()" class="button" style="background: #3b82f6;">üìù Log Mood</button>
                        <button onclick="showMoodHistory()" class="button" style="background: #8b5cf6;">üìà View History</button>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', `<div id="moodTrackerSection">${moodHTML}</div>`);
            document.getElementById('dashboardSection').style.display = 'none';
        }

        function getLast7DaysMoods(moodLogs) {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const last7Days = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dayName = i === 0 ? 'Today' : days[date.getDay()];

                const dayMoods = moodLogs.filter(log => {
                    const logDate = new Date(log.date);
                    return logDate.toDateString() === date.toDateString();
                });

                let emoji = 'üòê';
                if (dayMoods.length > 0) {
                    const lastMood = dayMoods[dayMoods.length - 1];
                    emoji = lastMood.emoji;
                }

                last7Days.push({ day: dayName, emoji, date });
            }

            return last7Days;
        }

        function generateMoodInsights(moodLogs) {
            if (moodLogs.length === 0) {
                return `
                    <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <h4 style="margin: 0 0 8px 0;">üí° Start Tracking</h4>
                        <p style="margin: 0; font-size: 0.9rem; color: #6b7280;">
                            Begin logging your moods to see patterns and insights about your emotional well-being.
                        </p>
                    </div>
                `;
            }

            const recentMoods = moodLogs.slice(-14); // Last 2 weeks
            const moodCounts = {};
            recentMoods.forEach(log => {
                moodCounts[log.mood] = (moodCounts[log.mood] || 0) + 1;
            });

            const totalLogs = recentMoods.length;
            const positiveCount = (moodCounts.happy || 0) + (moodCounts.excited || 0);
            const negativeCount = (moodCounts.sad || 0) + (moodCounts.anxious || 0) + (moodCounts.lonely || 0);

            let insight = '';
            let recommendation = '';

            if (positiveCount > negativeCount) {
                insight = "You've been feeling mostly positive lately! üåü";
                recommendation = "Keep doing what makes you happy and consider sharing your positive strategies with others.";
            } else if (negativeCount > positiveCount) {
                insight = "You've had some challenging days recently. üíô";
                recommendation = "Consider trying our wellness tools, talking to someone, or practicing self-care activities.";
            } else {
                insight = "Your mood has been balanced with ups and downs. üìä";
                recommendation = "This is completely normal! Continue tracking to identify what helps improve your mood.";
            }

            return `
                <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <h4 style="margin: 0 0 8px 0;">üí° Your Insights</h4>
                    <p style="margin: 0 0 8px 0; font-size: 0.9rem; color: #374151;">${insight}</p>
                    <p style="margin: 0; font-size: 0.9rem; color: #6b7280;">${recommendation}</p>
                    <div style="margin-top: 12px; font-size: 0.8rem; color: #9ca3af;">
                        Based on ${totalLogs} mood entries in the last 2 weeks
                    </div>
                </div>
            `;
        }

        function showMoodHistory() {
            const moodLogs = JSON.parse(localStorage.getItem('moodLogs') || '[]');

            if (moodLogs.length === 0) {
                showSuccess('üìà Mood History\n\nNo mood logs yet. Start tracking your moods to see patterns over time!');
                return;
            }

            const historyHTML = `
                <div class="card" style="max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #1f2937; margin: 0;">üìà Mood History</h2>
                        <button onclick="closeMoodHistory()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úï</button>
                    </div>

                    <div style="display: grid; gap: 10px;">
                        ${moodLogs.slice(-20).reverse().map(log => `
                            <div style="display: flex; align-items: center; padding: 12px; background: white; border-radius: 8px; border-left: 4px solid #06b6d4;">
                                <div style="font-size: 1.5rem; margin-right: 12px;">${log.emoji}</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #1f2937;">${log.label}</div>
                                    <div style="font-size: 0.8rem; color: #6b7280;">${new Date(log.date).toLocaleString()}</div>
                                    ${log.note ? `<div style="font-size: 0.9rem; color: #374151; margin-top: 4px;">${log.note}</div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', `<div id="moodHistorySection">${historyHTML}</div>`);
        }

        function closeMoodTracker() {
            const section = document.getElementById('moodTrackerSection');
            if (section) section.remove();
            showDashboard();
        }

        function closeMoodHistory() {
            const section = document.getElementById('moodHistorySection');
            if (section) section.remove();
        }

        function showEmergencySupport() {
            if (confirm('üÜò CRISIS SUPPORT\n\nIf you\'re having thoughts of self-harm or suicide, please reach out for immediate help:\n\n‚Ä¢ National Suicide Prevention Lifeline: 988\n‚Ä¢ Crisis Text Line: Text HOME to 741741\n‚Ä¢ Emergency Services: 911\n\nWould you like to chat with our AI companion for immediate support?')) {
                startAIChat();
                // Send emergency context to AI
                setTimeout(() => {
                    document.getElementById('aiMessageInput').value = 'I need immediate emotional support';
                    sendAIMessage();
                }, 1000);
            }
        }

        // PWA Installation Functions (Hidden from UI)
        function showInstallInfo() {
            // Install UI hidden - function disabled
            return;
        }

        function closeInstallInfo() {
            // Install UI hidden - function disabled
            return;
        }

        function triggerInstall() {
            // Install UI hidden - users can still install via browser's native prompt
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showSuccess('üéâ SoulConnect installed successfully!\n\nYou can now access it from your home screen like any other app.');
                    }
                    deferredPrompt = null;
                });
            }
        }

        function showManualInstall() {
            closeInstallInfo();

            const userAgent = navigator.userAgent.toLowerCase();
            let instructions = '';

            if (userAgent.includes('iphone') || userAgent.includes('ipad')) {
                instructions = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 3rem; margin-bottom: 10px;">üçé</div>
                        <h4 style="margin: 0; color: #1f2937;">Install on iPhone/iPad</h4>
                    </div>

                    <div style="display: grid; gap: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                            <div style="background: #2563eb; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold;">1</div>
                            <div>Tap the <strong>Share</strong> button (üì§) in Safari</div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                            <div style="background: #2563eb; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold;">2</div>
                            <div>Scroll down and tap <strong>"Add to Home Screen"</strong></div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                            <div style="background: #2563eb; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold;">3</div>
                            <div>Tap <strong>"Add"</strong> to confirm</div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                            <div style="background: #10b981; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold;">‚úì</div>
                            <div>SoulConnect will appear on your home screen!</div>
                        </div>
                    </div>
                `;
            } else if (userAgent.includes('android')) {
                instructions = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 3rem; margin-bottom: 10px;">ü§ñ</div>
                        <h4 style="margin: 0; color: #1f2937;">Install on Android</h4>
                    </div>

                    <div style="display: grid; gap: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                            <div style="background: #2563eb; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold;">1</div>
                            <div>Tap the <strong>Menu</strong> button (‚ãÆ) in Chrome</div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                            <div style="background: #2563eb; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold;">2</div>
                            <div>Tap <strong>"Add to Home screen"</strong> or <strong>"Install app"</strong></div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                            <div style="background: #2563eb; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold;">3</div>
                            <div>Tap <strong>"Install"</strong> to confirm</div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                            <div style="background: #10b981; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold;">‚úì</div>
                            <div>SoulConnect will install like a regular app!</div>
                        </div>
                    </div>
                `;
            } else {
                instructions = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 3rem; margin-bottom: 10px;">üíª</div>
                        <h4 style="margin: 0; color: #1f2937;">Install on Desktop</h4>
                    </div>

                    <div style="display: grid; gap: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                            <div style="background: #2563eb; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold;">1</div>
                            <div>Look for the <strong>Install</strong> icon (üì±) in your browser's address bar</div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                            <div style="background: #2563eb; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold;">2</div>
                            <div>Or go to <strong>Browser Menu ‚Üí Install SoulConnect</strong></div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                            <div style="background: #2563eb; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold;">3</div>
                            <div>Click <strong>"Install"</strong> when prompted</div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                            <div style="background: #10b981; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold;">‚úì</div>
                            <div>SoulConnect will open in its own window!</div>
                        </div>
                    </div>
                `;
            }

            const modalHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; padding: 20px; box-sizing: border-box;">
                    <div style="background: white; border-radius: 16px; max-width: 500px; margin: 50px auto; padding: 24px; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #1f2937;">üì± Install Instructions</h3>
                            <button onclick="closeManualInstall()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úï</button>
                        </div>

                        ${instructions}

                        <div style="margin-top: 24px; padding: 16px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                            <div style="font-weight: 600; color: #0c4a6e; margin-bottom: 4px;">üí° Why Install?</div>
                            <div style="font-size: 0.9rem; color: #075985;">Installing SoulConnect gives you faster access, offline support, and a native app experience for better mental health care.</div>
                        </div>

                        <button onclick="closeManualInstall()" class="button" style="background: #2563eb; width: 100%; margin-top: 16px;">
                            Got it!
                        </button>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', `<div id="manualInstallModal">${modalHTML}</div>`);
        }

        function closeManualInstall() {
            const modal = document.getElementById('manualInstallModal');
            if (modal) modal.remove();
        }

        // Install button removed - PWA still works via browser prompts
        function addInstallButton() {
            // Install button removed from UI
            // PWA installation still available through browser's native install prompt
            return;
        }

        // Handle URL shortcuts
        function handleURLShortcuts() {
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');

            if (action && currentUser) {
                setTimeout(() => {
                    switch(action) {
                        case 'ai-chat':
                            startAIChat();
                            break;
                        case 'find-friend':
                            startChat();
                            break;
                        case 'wellness':
                            showWellnessCenter();
                            break;
                        case 'crisis':
                            showEmergencySupport();
                            break;
                    }
                }, 1000);
            }
        }

        // Enhanced logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                console.log('üö™ User logging out');

                // Clear all user data
                localStorage.removeItem('soulconnect_user');
                localStorage.removeItem('soulconnect_token');
                localStorage.removeItem('soulconnect_logged_in');
                localStorage.removeItem('soulconnect_last_login');

                // Reset global variables
                currentUser = null;
                authToken = null;
                currentChatRoom = null;
                aiConversationHistory = [];

                // Stop any active polling
                if (messagePolling) {
                    clearInterval(messagePolling);
                    messagePolling = null;
                }

                // Hide all sections and show auth
                document.getElementById('dashboardSection').style.display = 'none';
                document.getElementById('chatSection').style.display = 'none';
                document.getElementById('aiChatSection').style.display = 'none';
                document.getElementById('authSection').style.display = 'block';

                // Clear any dynamic sections
                ['wellnessSection', 'journalSection', 'moodSection', 'copingSection',
                 'moodTrackerSection', 'journalHistorySection', 'moodHistorySection',
                 'moodLogSection', 'breathingSection', 'meditationSection'].forEach(sectionId => {
                    const section = document.getElementById(sectionId);
                    if (section) section.remove();
                });

                showSuccess('üëã You have been logged out successfully.\n\nThank you for using SoulConnect. Take care of yourself! üíô');

                console.log('‚úÖ Logout complete');
            }
        }

        // Check for existing session on page load
        function checkExistingSession() {
            const savedUser = localStorage.getItem('soulconnect_user');
            const savedToken = localStorage.getItem('soulconnect_token');
            const isLoggedIn = localStorage.getItem('soulconnect_logged_in');
            const lastLogin = localStorage.getItem('soulconnect_last_login');

            if (savedUser && savedToken && isLoggedIn === 'true') {
                try {
                    currentUser = JSON.parse(savedUser);
                    authToken = savedToken;

                    console.log('‚úÖ Found existing session for:', currentUser.username);

                    // Check if session is still valid (within 30 days)
                    if (lastLogin) {
                        const loginDate = new Date(lastLogin);
                        const now = new Date();
                        const daysSinceLogin = (now - loginDate) / (1000 * 60 * 60 * 24);

                        if (daysSinceLogin < 30) {
                            // Valid session - auto login
                            document.getElementById('authSection').style.display = 'none';
                            showDashboard();
                            loadStats();

                            console.log('üîê Auto-login successful');

                            // Show brief welcome back message
                            setTimeout(() => {
                                showSuccess(`Welcome back, ${currentUser.username}! üíô\n\nYour session has been restored.`);
                            }, 1000);

                            return true; // Session restored
                        }
                    }

                    // Session expired or invalid
                    console.log('‚è∞ Session expired, clearing data');
                    logout();
                } catch (error) {
                    console.error('‚ùå Error loading saved session:', error);
                    logout();
                }
            }

            return false; // No valid session
        }

        // Initialize app
        window.addEventListener('load', function() {
            console.log('üöÄ SoulConnect initializing...');

            // Check for existing session first
            const hasSession = checkExistingSession();

            if (!hasSession) {
                // No session - show welcome message
                setTimeout(() => {
                    showSuccess('üíô Welcome to SoulConnect!\n\nYour complete mental health companion!\n\nü§ñ AI Companion - Chat anytime\nüéØ Anonymous Friends - Connect safely\nüìä Mood Tracking - Understand patterns\nüå± Wellness Center - Self-care tools\nüìù Personal Journal - Process feelings\n\nYou\'re never alone! ü§ó');
                }, 1000);
            }

            // Handle URL shortcuts
            setTimeout(() => {
                handleURLShortcuts();
            }, 2000);
        });

        // Service Worker Registration (for PWA)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>
